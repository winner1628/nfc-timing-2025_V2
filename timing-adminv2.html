<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š NFC è¨ˆæ™‚å¾Œå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #ffffff; 
      color: #000000; 
      padding: 20px; 
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    input { padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; width: 300px; margin-right: 12px; }
    button { padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { background: #2563eb; }
    .controls { margin: 20px 0; }
    .mode-toggle { display: inline-block; margin-right: 20px; font-size: 18px; font-weight: bold; color: #000000; }
    .mode-btn { padding: 8px 16px; margin: 0 4px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; color: #000000; }
    .mode-btn.active { background: #10b981; color: white; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    th, td { padding: 16px; text-align: left; border-bottom: 1px solid #e2e8f0; color: #000000 !important; }
    th { background: #f1f5f9; font-weight: bold; color: #000000 !important; }
    .gold { background: #fef3c7; color: #000000 !important; } 
    .silver { background: #e0f2fe; color: #000000 !important; } 
    .bronze { background: #fed7aa; color: #000000 !important; }
    #log { background: #f8f9fa; padding: 20px; border-radius: 12px; max-height: 200px; overflow-y: auto; font-family: monospace; color: #000000; }
    .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
    .stat-number { font-size: 36px; font-weight: bold; color: #000000; }
    .stat-label { color: #000000; margin-top: 8px; font-weight: 500; font-size: 18px; }
    /* å„ªåŒ–æ¯”è³½é€²åº¦åœ–è¡¨æ¨£å¼ */
    .chart-container { 
      background: white; 
      padding: 24px; 
      border-radius: 16px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
      margin-bottom: 24px; 
      width: 100%; 
      max-width: 800px; 
      margin-left: auto; 
      margin-right: auto;
      height: 400px; 
      position: relative;
    }
    .chart-title {
      font-size: 24px;
      font-weight: bold;
      color: #1e293b;
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f1f5f9;
    }
    
    /* å°èˆªæ¨£å¼ */
    .navigation { margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }
    .nav-btn { padding: 8px 16px; margin-right: 10px; background: #f1f5f9; color: #000000 !important; font-weight: 700; font-size: 16px; }
    .nav-btn.active { background: #3b82f6; color: white !important; }
    
    /* é é¢å®¹å™¨æ¨£å¼ */
    .page { display: none; }
    .page.active { display: block; }
    
    /* ç¯©é¸å™¨æ¨£å¼ */
    .filters { margin: 16px 0; padding: 16px; background: #f8fafc; border-radius: 8px; }
    select, .filter-input { padding: 8px 12px; margin-right: 12px; border: 1px solid #e2e8f0; border-radius: 4px; color: #000000; }
    
    /* é é¢æ¨™é¡Œæ¨£å¼ */
    h1, h2, h3 { color: #000000 !important; }
    
    /* æ¨¡æ…‹æ¡†æ–‡å­—é¡è‰² */
    #manageUsersModal { color: #000000 !important; }
    #manageUsersModal h2, #manageUsersModal h3, #manageUsersModal p { color: #000000 !important; }
    
    /* å›¾è¡¨canvasæ ·å¼ */
    #progressChartCanvas {
      width: 100% !important;
      height: 300px !important;
    }
    
    /* æ¯å€‹é é¢ç¨ç«‹çš„æ—¥èªŒå€åŸŸ */
    .page-log {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      color: #000000;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š NFC è·‘æ‰‹è¨ˆæ™‚å¾Œå°</h1>
      <div>
        <input id="adminUrl" placeholder="https://your-supabase-url.supabase.co" value="" style="display: none;">
        <input id="adminKey" placeholder="your-supabase-key" type="password" value="" style="display: none;">
        <button onclick="connectAdmin()">ğŸ”— é€£ç·šå¾Œå°</button>
        <button onclick="exportCSV()" style="background: #10b981; float: right; margin-left: 8px;">ğŸ’¾ åŒ¯å‡º CSV</button>
        <button onclick="showManageUsersModal()" style="background: #6366f1; float: right; margin-left: 8px;">ğŸ‘¥ ç®¡ç†åƒè³½è€…</button>
        <button onclick="clearAllData()" style="background: #ef4444; float: right;">ğŸ—‘ï¸ æ¸…ç©ºæ•¸æ“š</button>
      </div>
      <div id="status" style="margin-top: 12px; padding: 8px; border-radius: 8px; font-weight: bold; color: #000000;">æœªé€£ç·š</div>
    </div>
    
    <!-- é é¢å°èˆª -->
    <div class="navigation" id="navigation" style="display: none;">
      <button class="nav-btn active" onclick="showPage('overview')">ç¸½è¦½</button>
      <button class="nav-btn" onclick="showPage('ranking')">æ’åè©³æƒ…</button>
      <button class="nav-btn" onclick="showPage('checkins')">æ‰“å¡è¨˜éŒ„</button>
    </div>
    
    <!-- ç¸½è¦½é é¢ -->
    <div id="overview-page" class="page active">
      <div class="dashboard" id="dashboard" style="display: none;">
        <div class="stat-card">
          <div class="stat-number" id="totalRunners">0</div>
          <div class="stat-label">ç¸½åƒè³½äººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="startedRunners">0</div>
          <div class="stat-label">å·²å‡ºç™¼äººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="finishedRunners">0</div>
          <div class="stat-label">å·²å®Œè³½äººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgTime">00:00</div>
          <div class="stat-label">å¹³å‡å®Œè³½æ™‚é–“</div>
        </div>
      </div>
      
      <div class="chart-container" id="progressChart" style="display: none;">
        <div class="chart-title">ğŸ“ˆ æ¯”è³½é€²åº¦</div>
        <canvas id="progressChartCanvas"></canvas>
      </div>
      
      <div class="controls">
        <div class="mode-toggle">
          ğŸ† æ’åæ¨¡å¼: 
          <button class="mode-btn active" onclick="setMode('gun', event)">ğŸ¯ çµ‚é»å…ˆå¾Œ</button>
          <button class="mode-btn" onclick="setMode('chip', event)">â±ï¸ å¯¦éš›ç”¨æ™‚</button>
          <button class="mode-btn" onclick="setMode('split', event)">ğŸ“Š åˆ†æ®µæˆç¸¾</button>
        </div>
        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°è³‡æ–™</button>
      </div>
      
      <table id="resultsTable">
        <thead>
          <tr>
            <th>æ’å</th>
            <th>è™Ÿç¢¼</th>
            <th>å§“å</th>
            <th>èµ·è·‘æ™‚é–“</th>
            <th>å®Œè³½æ™‚é–“</th>
            <th>ç”¨æ™‚</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <!-- ç¸½è¦½é é¢ç¨ç«‹æ—¥èªŒ -->
      <div style="margin-top: 24px;">
        <h3>ğŸ“ æœ€æ–°æ‰“å¡è¨˜éŒ„</h3>
        <div id="overview-log" class="page-log"></div>
      </div>
    </div>
    
    <!-- æ’åè©³æƒ…é  -->
    <div id="ranking-page" class="page">
      <h2>ğŸ† æ’åè©³æƒ…</h2>
      <div class="filters">
        <select id="rankingCheckpointFilter" onchange="refreshData()">
          <option value="all">æ‰€æœ‰æª¢æŸ¥é»</option>
        </select>
        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ’å</button>
      </div>
      <div class="mode-toggle">
        æ’åæ¨¡å¼: 
        <button class="mode-btn active" onclick="setMode('gun', event)">ğŸ¯ æŒ‰çµ‚é»æ™‚é–“</button>
        <button class="mode-btn" onclick="setMode('chip', event)">â±ï¸ æŒ‰å¯¦éš›ç”¨æ™‚</button>
        <button class="mode-btn" onclick="setMode('split', event)">ğŸ“Š æŒ‰åˆ†æ®µæˆç¸¾</button>
      </div>
      <table id="detailedRankingTable">
        <thead>
          <tr>
            <th>æ’å</th>
            <th>è™Ÿç¢¼</th>
            <th>å§“å</th>
            <th>å„æª¢æŸ¥é»æ™‚é–“</th>
            <th>ç¸½ç”¨æ™‚</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <!-- æ’åé é¢ç¨ç«‹æ—¥èªŒ -->
      <div style="margin-top: 24px;">
        <h3>ğŸ“ æœ€æ–°æ‰“å¡è¨˜éŒ„</h3>
        <div id="ranking-log" class="page-log"></div>
      </div>
    </div>
    
    <!-- æ‰“å¡è¨˜éŒ„é  -->
    <div id="checkins-page" class="page">
      <h2>ğŸ“ æ‰“å¡è¨˜éŒ„</h2>
      <div class="filters">
        <select id="checkpointFilter" onchange="filterCheckins()">
          <option value="all">æ‰€æœ‰æª¢æŸ¥é»</option>
        </select>
        <input type="text" id="bibFilter" placeholder="æœå°‹è™Ÿç¢¼" class="filter-input" oninput="filterCheckins()">
        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°è¨˜éŒ„</button>
      </div>
      <table id="checkinsTable">
        <thead>
          <tr>
            <th>æ™‚é–“</th>
            <th>è™Ÿç¢¼</th>
            <th>å§“å</th>
            <th>æª¢æŸ¥é»</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <!-- æ‰“å¡è¨˜éŒ„é é¢ç¨ç«‹æ—¥èªŒ -->
      <div style="margin-top: 24px;">
        <h3>ğŸ“ æœ€æ–°æ‰“å¡è¨˜éŒ„</h3>
        <div id="checkins-log" class="page-log"></div>
      </div>
    </div>
    
  </div>

  <!-- ç®¡ç†åƒè³½è€…æ¨¡æ…‹æ¡† -->
  <div id="manageUsersModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 16px; padding: 32px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; color: #000000;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2>ğŸ‘¥ ç®¡ç†åƒè³½è€…</h2>
        <button onclick="hideManageUsersModal()" style="background: #64748b; padding: 8px 16px;">âœ• é—œé–‰</button>
      </div>
      
      <!-- æª¢æŸ¥é»é…ç½® -->
      <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 12px;">
        <h3>ğŸš© æª¢æŸ¥é»é…ç½®</h3>
        <p style="margin-bottom: 16px; color: #000000;">è¨­ç½®æœ¬æ¬¡æ¯”è³½çš„æª¢æŸ¥é»ï¼ˆæœ€å°‘2å€‹ï¼Œæœ€å¤š10å€‹ï¼‰</p>
        
        <div style="margin-bottom: 16px;">
          <label style="color: #000000;">æª¢æŸ¥é»æ•¸é‡ï¼š</label>
          <input type="number" id="checkpointCount" min="2" max="10" value="2" style="width: 80px;">
          <button onclick="updateCheckpointFields()" style="background: #3b82f6;">æ›´æ–°æ•¸é‡</button>
        </div>
        
        <div id="checkpointFields">
          <div class="checkpoint-field" style="display: flex; gap: 12px; margin-bottom: 8px;">
            <input placeholder="ä»£ç¢¼ï¼ˆå¦‚STARTï¼‰" style="width: 120px;" value="START">
            <input placeholder="åç¨±ï¼ˆå¦‚èµ·é»ï¼‰" style="flex: 1;" value="èµ·é»">
            <input type="number" placeholder="é †åº" style="width: 80px;" value="1">
            <label style="margin-top: 12px; color: #000000;">å¿…é: <input type="checkbox" checked></label>
          </div>
          <div class="checkpoint-field" style="display: flex; gap: 12px; margin-bottom: 8px;">
            <input placeholder="ä»£ç¢¼ï¼ˆå¦‚FINISHï¼‰" style="width: 120px;" value="FINISH">
            <input placeholder="åç¨±ï¼ˆå¦‚çµ‚é»ï¼‰" style="flex: 1;" value="çµ‚é»">
            <input type="number" placeholder="é †åº" style="width: 80px;" value="2">
            <label style="margin-top: 12px; color: #000000;">å¿…é: <input type="checkbox" checked></label>
          </div>
        </div>
        
        <button onclick="saveCheckpointConfigs()" style="background: #22c55e;">ä¿å­˜æª¢æŸ¥é»é…ç½®</button>
      </div>
      
      <!-- CSV å°å…¥åŠŸèƒ½ -->
      <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 12px;">
        <h3>ğŸ“ å¾ CSV å°å…¥åƒè³½è€…</h3>
        <p style="color: #000000; margin-bottom: 16px;">CSV æ ¼å¼ï¼šè™Ÿç¢¼,å§“åï¼ˆä¾‹å¦‚ï¼š001,å¼µä¸‰ï¼‰</p>
        <input type="file" id="csvFileInput" accept=".csv" style="margin-bottom: 16px;">
        <button onclick="importFromCSV()" style="background: #22c55e;">ğŸ“¥ å°å…¥ CSV</button>
        <div id="csvImportStatus" style="margin-top: 16px; font-family: monospace; color: #000000;"></div>
      </div>
      
      <!-- æ‰‹å‹•æ·»åŠ åƒè³½è€… -->
      <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 12px;">
        <h3>â• æ‰‹å‹•æ·»åŠ åƒè³½è€…</h3>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          <input id="manualBibNumber" placeholder="è™Ÿç¢¼ï¼ˆå¦‚ï¼š001ï¼‰" style="width: 150px;">
          <input id="manualName" placeholder="å§“å" style="flex: 1;">
          <button onclick="addSingleUser()" style="background: #3b82f6;">â• æ·»åŠ </button>
        </div>
      </div>
      
      <!-- åƒè³½è€…åˆ—è¡¨ -->
      <div>
        <h3>ğŸ“‹ åƒè³½è€…åˆ—è¡¨</h3>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
          <table id="participantsTable" style="width: 100%; border-radius: 8px;">
            <thead>
              <tr>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; background: #f1f5f9; color: #000000;">è™Ÿç¢¼</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; background: #f1f5f9; color: #000000;">å§“å</th>
                <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0; background: #f1f5f9; color: #000000;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="participantsTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let adminClient = null;
    let rankingMode = 'gun';
    let progressChart = null;
    let checkpoints = [];
    let allCheckins = [];
    let autoRefreshInterval = null;

    window.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('nfc_admin_url');
      const savedKey = localStorage.getItem('nfc_admin_key');
      
      if (savedUrl && savedKey) {
        document.getElementById('adminUrl').value = savedUrl;
        document.getElementById('adminKey').value = savedKey;
        setTimeout(() => connectAdmin(), 1000);
      }
    });

    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(`${pageId}-page`).classList.add('active');
      
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      if (pageId === 'ranking') loadRankingData();
      else if (pageId === 'checkins') loadCheckinsData();
      else refreshData();
    }

    function updateCheckpointFields() {
      const count = parseInt(document.getElementById('checkpointCount').value);
      const container = document.getElementById('checkpointFields');
      container.innerHTML = '';
      
      for (let i = 1; i <= count; i++) {
        const code = i === 1 ? 'START' : i === count ? 'FINISH' : `CP${i-1}`;
        const name = i === 1 ? 'èµ·é»' : i === count ? 'çµ‚é»' : `æª¢æŸ¥é»${i-1}`;
        
        const field = document.createElement('div');
        field.className = 'checkpoint-field';
        field.style = 'display: flex; gap: 12px; margin-bottom: 8px;';
        field.innerHTML = `
          <input placeholder="ä»£ç¢¼" style="width: 120px;" value="${code}">
          <input placeholder="åç¨±" style="flex: 1;" value="${name}">
          <input type="number" placeholder="é †åº" style="width: 80px;" value="${i}">
          <label style="margin-top: 12px; color: #000000;">å¿…é: <input type="checkbox" ${i === 1 || i === count ? 'checked' : ''}></label>
        `;
        container.appendChild(field);
      }
    }

    async function saveCheckpointConfigs() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£ç·šæ•¸æ“šåº«');
        return;
      }
      
      const fields = document.querySelectorAll('.checkpoint-field');
      const configs = Array.from(fields).map((field) => {
        const inputs = field.querySelectorAll('input');
        return {
          code: inputs[0].value,
          name: inputs[1].value,
          order_index: parseInt(inputs[2].value),
          is_required: inputs[3].checked,
          event_id: 'default'
        };
      });
      
      const { error: deleteError } = await adminClient
        .from('checkpoint_configs')
        .delete()
        .eq('event_id', 'default');
      
      if (deleteError) {
        alert('åˆªé™¤èˆŠé…ç½®å¤±æ•—: ' + deleteError.message);
        return;
      }
      
      const { error } = await adminClient
        .from('checkpoint_configs')
        .insert(configs);
      
      if (error) {
        alert('ä¿å­˜æª¢æŸ¥é»é…ç½®å¤±æ•—: ' + error.message);
      } else {
        alert('æª¢æŸ¥é»é…ç½®å·²ä¿å­˜');
        await loadCheckpoints();
        refreshData();
      }
    }

    async function loadCheckpoints() {
      if (!adminClient) return;
      
      const { data, error } = await adminClient
        .from('checkpoint_configs')
        .select('*')
        .eq('event_id', 'default')
        .order('order_index');
      
      if (error) {
        console.error('åŠ è¼‰æª¢æŸ¥é»é…ç½®å¤±æ•—:', error);
        checkpoints = [
          { code: 'START', name: 'èµ·é»', order_index: 1, is_required: true },
          { code: 'FINISH', name: 'çµ‚é»', order_index: 2, is_required: true }
        ];
      } else {
        checkpoints = data.length > 0 ? data : [
          { code: 'START', name: 'èµ·é»', order_index: 1, is_required: true },
          { code: 'FINISH', name: 'çµ‚é»', order_index: 2, is_required: true }
        ];
      }
      
      updateCheckpointFilters();
    }

    function updateCheckpointFilters() {
      const filters = [
        document.getElementById('checkpointFilter'),
        document.getElementById('rankingCheckpointFilter')
      ];
      
      filters.forEach(filter => {
        if (!filter) return;
        
        const currentValue = filter.value;
        while (filter.options.length > 1) filter.remove(1);
        
        checkpoints.forEach(checkpoint => {
          const option = document.createElement('option');
          option.value = checkpoint.code;
          option.textContent = checkpoint.name;
          filter.appendChild(option);
        });
        
        if (currentValue) filter.value = currentValue;
      });
    }

    async function connectAdmin() {
      const url = document.getElementById('adminUrl').value.trim();
      const key = document.getElementById('adminKey').value.trim();
      const status = document.getElementById('status');

      try {
        if (!url || !key) {
          alert('URL æˆ– Key ç„¡å¡«');
          return;
        }

        localStorage.setItem('nfc_admin_url', url);
        localStorage.setItem('nfc_admin_key', key);

        adminClient = window.supabase.createClient(url, key);

        status.textContent = 'é€£ç·šä¸­...';
        status.style.background = '#f59e0b';

        // æ¸¬è©¦é€£æ¥
        const { data, error } = await adminClient
          .from('participants')
          .select('*', { count: 'exact', head: true });

        if (error) throw new Error('è®€å– participants å‡ºéŒ¯ï¼š' + error.message);

        status.textContent = 'âœ… å¾Œå°å·²é€£ç·š';
        status.style.background = '#10b981';

        document.getElementById('navigation').style.display = 'block';
        document.getElementById('dashboard').style.display = 'grid';
        document.getElementById('progressChart').style.display = 'block';

        await loadCheckpoints();
        await loadParticipants();
        await refreshData();

        // è¨­ç½®å¯¦æ™‚ç›£è½
        setupRealtimeUpdates();
        
        // è¨­ç½®è‡ªå‹•åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(refreshData, 5000);

      } catch (e) {
        console.error('é€£æ¥éŒ¯èª¤:', e);
        status.textContent = 'âŒ é€£ç·šå¤±æ•—';
        status.style.background = '#ef4444';
        alert('é€£ç·šå¤±æ•—ï¼š' + e.message);
      }
    }

    function setupRealtimeUpdates() {
      if (!adminClient) return;
      
      // ç›£è½æ‰“å¡è¨˜éŒ„è®ŠåŒ–
      adminClient
        .channel('public:checkins')
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'checkins' },
          (payload) => {
            logMessage(`ğŸ“¥ æ–°æ‰“å¡: ${payload.new.bib_number} @ ${payload.new.checkpoint}`);
            refreshData();
          }
        )
        .on(
          'postgres_changes',
          { event: 'DELETE', schema: 'public', table: 'checkins' },
          () => {
            logMessage(`ğŸ“¤ æ‰“å¡è¨˜éŒ„å·²åˆªé™¤`);
            refreshData();
          }
        )
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'participants' },
          () => {
            logMessage(`ğŸ‘¤ æ–°åƒè³½è€…å·²æ·»åŠ `);
            refreshData();
          }
        )
        .on(
          'postgres_changes',
          { event: 'DELETE', schema: 'public', table: 'participants' },
          () => {
            logMessage(`ğŸ‘¤ åƒè³½è€…å·²åˆªé™¤`);
            refreshData();
          }
        )
        .subscribe();
    }

    async function refreshData() {
      if (!adminClient) return;
      
      try {
        await loadDashboardStats();
        await loadResults();
        await loadCheckinsData();
        await loadRankingData();
      } catch (e) {
        console.error('åˆ·æ–°æ•¸æ“šå¤±æ•—:', e);
        logMessage(`âŒ åˆ·æ–°æ•¸æ“šå¤±æ•—: ${e.message}`);
      }
    }

    async function loadDashboardStats() {
      try {
        // 1. ç¸½åƒè³½äººæ•¸ - ç›´æ¥è¨ˆæ•¸
        const totalRunnersResult = await adminClient
          .from('participants')
          .select('*', { count: 'exact', head: true });
        const totalRunners = totalRunnersResult.count || 0;
        
        // 2. å·²å‡ºç™¼äººæ•¸ - ç²å–æ‰€æœ‰èµ·é»æ‰“å¡è¨˜éŒ„ä¸¦å»é‡
        const { data: startCheckins } = await adminClient
          .from('checkins')
          .select('bib_number')
          .eq('checkpoint', 'START');
        
        const startedBibs = new Set();
        if (startCheckins && startCheckins.length > 0) {
          startCheckins.forEach(c => {
            if (c.bib_number) startedBibs.add(c.bib_number);
          });
        }
        const startedRunners = startedBibs.size;
        
        // 3. å·²å®Œè³½äººæ•¸ - ç²å–æ‰€æœ‰çµ‚é»æ‰“å¡è¨˜éŒ„ä¸¦å»é‡
        const { data: finishCheckins } = await adminClient
          .from('checkins')
          .select('bib_number')
          .eq('checkpoint', 'FINISH');
        
        const finishedBibs = new Set();
        if (finishCheckins && finishCheckins.length > 0) {
          finishCheckins.forEach(c => {
            if (c.bib_number) finishedBibs.add(c.bib_number);
          });
        }
        const finishedRunners = finishedBibs.size;
        
        // 4. å¹³å‡å®Œè³½æ™‚é–“ - ç²¾ç¢ºè¨ˆç®—
        let avgTime = '00:00:00';
        if (finishedRunners > 0) {
          let totalSeconds = 0;
          let validCount = 0;
          
          // éæ­·æ¯å€‹å®Œè³½é¸æ‰‹
          for (const bib of finishedBibs) {
            // ç²å–è©²é¸æ‰‹çš„èµ·é»è¨˜éŒ„
            const { data: startData } = await adminClient
              .from('checkins')
              .select('time')
              .eq('bib_number', bib)
              .eq('checkpoint', 'START')
              .order('time', { ascending: true })
              .limit(1);
            
            // ç²å–è©²é¸æ‰‹çš„çµ‚é»è¨˜éŒ„
            const { data: finishData } = await adminClient
              .from('checkins')
              .select('time')
              .eq('bib_number', bib)
              .eq('checkpoint', 'FINISH')
              .order('time', { ascending: false })
              .limit(1);
            
            if (startData && startData.length > 0 && finishData && finishData.length > 0) {
              const startTime = new Date(startData[0].time).getTime();
              const finishTime = new Date(finishData[0].time).getTime();
              const duration = (finishTime - startTime) / 1000;
              
              if (duration > 0 && !isNaN(duration)) {
                totalSeconds += duration;
                validCount++;
              }
            }
          }
          
          if (validCount > 0) {
            const avgSeconds = totalSeconds / validCount;
            avgTime = formatTime(avgSeconds);
          }
        }
        
        // å¼·åˆ¶æ›´æ–°UI - ç¢ºä¿æ•¸æ“šé¡¯ç¤º
        document.getElementById('totalRunners').textContent = totalRunners.toString();
        document.getElementById('startedRunners').textContent = startedRunners.toString();
        document.getElementById('finishedRunners').textContent = finishedRunners.toString();
        document.getElementById('avgTime').textContent = avgTime;
        
        // æ›´æ–°åœ–è¡¨
        updateProgressChart(totalRunners, startedRunners, finishedRunners);
        
      } catch (error) {
        console.error('åŠ è¼‰çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error);
        logMessage(`âŒ åŠ è¼‰çµ±è¨ˆæ•¸æ“šå¤±æ•—: ${error.message}`);
        
        // ä¿åº•é¡¯ç¤º0å€¼
        document.getElementById('totalRunners').textContent = '0';
        document.getElementById('startedRunners').textContent = '0';
        document.getElementById('finishedRunners').textContent = '0';
        document.getElementById('avgTime').textContent = '00:00:00';
        
        // é¡¯ç¤ºç©ºåœ–è¡¨
        updateProgressChart(0, 0, 0);
      }
    }

    function updateProgressChart(total, started, finished) {
      const ctx = document.getElementById('progressChartCanvas').getContext('2d');
      
      // éŠ·æ¯€èˆŠåœ–è¡¨
      if (progressChart) {
        progressChart.destroy();
      }
      
      // ç¢ºä¿æ•¸å€¼åˆç†
      const notStarted = Math.max(0, total - started);
      const inProgress = Math.max(0, started - finished);
      
      // å‰µå»ºæ–°åœ–è¡¨ - å„ªåŒ–æ¨£å¼
      progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['æœªé–‹å§‹', 'æ¯”è³½ä¸­', 'å·²å®Œè³½'],
          datasets: [{
            data: [notStarted, inProgress, finished],
            backgroundColor: [
              '#94a3b8',  // æ·ºç°è‰² - æœªé–‹å§‹
              '#3b82f6',  // è—è‰² - æ¯”è³½ä¸­
              '#10b981'   // ç¶ è‰² - å·²å®Œè³½
            ],
            borderColor: '#ffffff',
            borderWidth: 4,
            hoverOffset: 15
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '70%',
          plugins: {
            legend: { 
              position: 'bottom',
              labels: {
                color: '#1e293b',
                font: {
                  size: 12,
                  weight: '600',
                  family: 'sans-serif'
                },
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle',
                boxWidth: 10
              }
            },
            tooltip: {
              backgroundColor: 'rgba(30, 41, 59, 0.9)',
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 12 },
              padding: 10,
              cornerRadius: 8,
              boxPadding: 4,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value} äºº (${percentage}%)`;
                }
              }
            },
            title: {
              display: false
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1500,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    async function loadResults() {
      try {
        const { data: participants } = await adminClient
          .from('participants')
          .select('bib_number, name');
        
        if (!participants || participants.length === 0) {
          const tableBody = document.getElementById('resultsTable').querySelector('tbody');
          tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#000000;">æš«ç„¡åƒè³½æ•¸æ“š</td></tr>';
          return;
        }
        
        // ç²å–æ‰€æœ‰èµ·é»è¨˜éŒ„
        const { data: startCheckins } = await adminClient
          .from('checkins')
          .select('bib_number, time')
          .eq('checkpoint', 'START');
        
        // ç²å–æ‰€æœ‰çµ‚é»è¨˜éŒ„
        const { data: finishCheckins } = await adminClient
          .from('checkins')
          .select('bib_number, time')
          .eq('checkpoint', 'FINISH');
        
        // å‰µå»ºå¿«é€ŸæŸ¥æ‰¾æ˜ å°„
        const startMap = new Map();
        if (startCheckins) {
          startCheckins.forEach(c => {
            if (!startMap.has(c.bib_number) || new Date(c.time) < new Date(startMap.get(c.bib_number))) {
              startMap.set(c.bib_number, c.time);
            }
          });
        }
        
        const finishMap = new Map();
        if (finishCheckins) {
          finishCheckins.forEach(c => {
            if (!finishMap.has(c.bib_number) || new Date(c.time) < new Date(finishMap.get(c.bib_number))) {
              finishMap.set(c.bib_number, c.time);
            }
          });
        }
        
        // åˆä½µæ•¸æ“š
        const results = participants.map(participant => {
          const start_time = startMap.get(participant.bib_number);
          const finish_time = finishMap.get(participant.bib_number);
          
          return {
            bib_number: participant.bib_number,
            name: participant.name,
            start_time: start_time,
            finish_time: finish_time,
            duration: start_time && finish_time 
              ? (new Date(finish_time).getTime() - new Date(start_time).getTime()) / 1000 
              : null
          };
        }).filter(r => r.start_time); // åªé¡¯ç¤ºå·²å‡ºç™¼çš„é¸æ‰‹
        
        // æ’åº
        if (rankingMode === 'gun') {
          results.sort((a, b) => {
            if (a.finish_time && b.finish_time) {
              return new Date(a.finish_time) - new Date(b.finish_time);
            } else if (a.finish_time) {
              return -1;
            } else if (b.finish_time) {
              return 1;
            } else {
              return new Date(a.start_time) - new Date(b.start_time);
            }
          });
        } else {
          results.sort((a, b) => {
            if (a.duration && b.duration) {
              return a.duration - b.duration;
            } else if (a.duration) {
              return -1;
            } else if (b.duration) {
              return 1;
            } else {
              return new Date(a.start_time) - new Date(b.start_time);
            }
          });
        }
        
        // æ›´æ–°è¡¨æ ¼
        const tableBody = document.getElementById('resultsTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        if (results.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#000000;">æš«ç„¡å‡ºç™¼è¨˜éŒ„</td></tr>';
          return;
        }
        
        results.forEach((result, index) => {
          const row = document.createElement('tr');
          if (index < 3) {
            row.className = index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze';
          }
          
          // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
          const formatDateTime = (dateStr) => {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          };
          
          row.innerHTML = `
            <td style="color:#000000; font-weight: bold;">${index + 1}</td>
            <td style="color:#000000;">${result.bib_number}</td>
            <td style="color:#000000;">${result.name}</td>
            <td style="color:#000000;">${formatDateTime(result.start_time)}</td>
            <td style="color:#000000;">${formatDateTime(result.finish_time)}</td>
            <td style="color:#000000; font-weight: bold;">${result.duration ? formatTime(result.duration) : '-'}</td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('åŠ è¼‰çµæœå¤±æ•—:', error);
        logMessage(`âŒ åŠ è¼‰çµæœå¤±æ•—: ${error.message}`);
        const tableBody = document.getElementById('resultsTable').querySelector('tbody');
        tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#000000;">åŠ è¼‰æ•¸æ“šå¤±æ•—: ${error.message}</td></tr>`;
      }
    }

    async function loadRankingData() {
      try {
        const filter = document.getElementById('rankingCheckpointFilter').value;
        
        const { data: participants } = await adminClient
          .from('participants')
          .select('bib_number, name');
        
        if (!participants || participants.length === 0) {
          const tableBody = document.getElementById('detailedRankingTable').querySelector('tbody');
          tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#000000;">æš«ç„¡åƒè³½æ•¸æ“š</td></tr>';
          return;
        }
        
        const { data: checkins } = await adminClient
          .from('checkins')
          .select('bib_number, checkpoint, time');
        
        // è™•ç†æ•¸æ“š
        const runnerData = {};
        
        // åˆå§‹åŒ–æ‰€æœ‰åƒè³½è€…
        participants.forEach(p => {
          runnerData[p.bib_number] = {
            bib_number: p.bib_number,
            name: p.name,
            checkpoints: {},
            total_time: null
          };
        });
        
        // å¡«å……æª¢æŸ¥é»æ•¸æ“š
        if (checkins) {
          checkins.forEach(c => {
            if (!runnerData[c.bib_number]) return;
            if (filter !== 'all' && c.checkpoint !== filter) return;
            
            // åªä¿ç•™æœ€æ—©çš„æ‰“å¡æ™‚é–“
            if (!runnerData[c.bib_number].checkpoints[c.checkpoint] || 
                new Date(c.time) < new Date(runnerData[c.bib_number].checkpoints[c.checkpoint])) {
              runnerData[c.bib_number].checkpoints[c.checkpoint] = c.time;
            }
          });
        }
        
        // è¨ˆç®—ç¸½æ™‚é–“
        Object.values(runnerData).forEach(runner => {
          const start = runner.checkpoints.START;
          const finish = runner.checkpoints.FINISH;
          
          if (start && finish) {
            runner.total_time = (new Date(finish).getTime() - new Date(start).getTime()) / 1000;
          }
        });
        
        // æ’åº
        const rankedRunners = Object.values(runnerData).filter(r => r.total_time !== null && r.total_time > 0);
        
        if (rankingMode === 'gun') {
          rankedRunners.sort((a, b) => new Date(a.checkpoints.FINISH) - new Date(b.checkpoints.FINISH));
        } else {
          rankedRunners.sort((a, b) => a.total_time - b.total_time);
        }
        
        // æ›´æ–°è¡¨æ ¼
        const tableBody = document.getElementById('detailedRankingTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        if (rankedRunners.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#000000;">æš«ç„¡å®Œè³½è¨˜éŒ„</td></tr>';
          return;
        }
        
        rankedRunners.forEach((runner, index) => {
          const row = document.createElement('tr');
          if (index < 3) {
            row.className = index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze';
          }
          
          // æ ¼å¼åŒ–æª¢æŸ¥é»æ™‚é–“
          const checkpointTimes = checkpoints.map(cp => {
            const time = runner.checkpoints[cp.code];
            const formattedTime = time ? new Date(time).toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '-';
            return `${cp.name}: ${formattedTime}`;
          }).join('<br>');
          
          row.innerHTML = `
            <td style="color:#000000; font-weight: bold;">${index + 1}</td>
            <td style="color:#000000;">${runner.bib_number}</td>
            <td style="color:#000000;">${runner.name}</td>
            <td style="color:#000000; font-size: 14px;">${checkpointTimes}</td>
            <td style="color:#000000; font-weight: bold;">${runner.total_time ? formatTime(runner.total_time) : '-'}</td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('åŠ è¼‰æ’åæ•¸æ“šå¤±æ•—:', error);
        logMessage(`âŒ åŠ è¼‰æ’åæ•¸æ“šå¤±æ•—: ${error.message}`);
        const tableBody = document.getElementById('detailedRankingTable').querySelector('tbody');
        tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#000000;">åŠ è¼‰æ•¸æ“šå¤±æ•—: ${error.message}</td></tr>`;
      }
    }

    async function loadCheckinsData() {
      try {
        const { data: checkins } = await adminClient
          .from('checkins')
          .select('*')
          .order('time', { ascending: false });
        
        allCheckins = checkins || [];
        
        // ç²å–åƒè³½è€…å§“åæ˜ å°„
        const { data: participants } = await adminClient
          .from('participants')
          .select('bib_number, name');
        
        const nameMap = new Map();
        if (participants) {
          participants.forEach(p => nameMap.set(p.bib_number, p.name));
        }
        
        // éæ¿¾ä¸¦æ›´æ–°è¡¨æ ¼
        filterCheckins(nameMap);
        
        // æ›´æ–°æ‰€æœ‰é é¢çš„æ—¥èªŒ
        const recentCheckins = [...allCheckins].reverse().slice(0, 10);
        let logHtml = '';
        recentCheckins.forEach(c => {
          const time = new Date(c.time).toLocaleString('zh-HK');
          const name = nameMap.get(c.bib_number) || 'æœªçŸ¥';
          logHtml += `[${time}] ${c.bib_number} (${name}) @ ${c.checkpoint}\n`;
        });
        
        document.getElementById('overview-log').textContent = logHtml;
        document.getElementById('ranking-log').textContent = logHtml;
        document.getElementById('checkins-log').textContent = logHtml;
        
      } catch (error) {
        console.error('åŠ è¼‰æ‰“å¡è¨˜éŒ„å¤±æ•—:', error);
        logMessage(`âŒ åŠ è¼‰æ‰“å¡è¨˜éŒ„å¤±æ•—: ${error.message}`);
        const tableBody = document.getElementById('checkinsTable').querySelector('tbody');
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#000000;">åŠ è¼‰æ•¸æ“šå¤±æ•—: ${error.message}</td></tr>`;
      }
    }

    function filterCheckins(nameMap = null) {
      try {
        const checkpointFilter = document.getElementById('checkpointFilter').value;
        const bibFilter = document.getElementById('bibFilter').value.toLowerCase();
        
        // å¦‚æœæ²’æœ‰å‚³å…¥nameMapï¼Œé‡æ–°ç²å–
        if (!nameMap) {
          const participants = Array.from(document.querySelectorAll('#participantsTableBody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            return {
              bib_number: cells[0].textContent,
              name: cells[1].textContent
            };
          });
          
          nameMap = new Map();
          participants.forEach(p => nameMap.set(p.bib_number, p.name));
        }
        
        // éæ¿¾æ•¸æ“š
        let filteredCheckins = allCheckins;
        
        if (checkpointFilter !== 'all') {
          filteredCheckins = filteredCheckins.filter(c => c.checkpoint === checkpointFilter);
        }
        
        if (bibFilter) {
          filteredCheckins = filteredCheckins.filter(c => 
            c.bib_number.toLowerCase().includes(bibFilter) || 
            (nameMap.get(c.bib_number) && nameMap.get(c.bib_number).toLowerCase().includes(bibFilter))
          );
        }
        
        // æ›´æ–°è¡¨æ ¼
        const tableBody = document.getElementById('checkinsTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        if (filteredCheckins.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#000000;">æš«ç„¡è¨˜éŒ„</td></tr>';
          return;
        }
        
        filteredCheckins.forEach(c => {
          const row = document.createElement('tr');
          const time = new Date(c.time).toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          const name = nameMap.get(c.bib_number) || 'æœªçŸ¥';
          
          row.innerHTML = `
            <td style="color:#000000;">${time}</td>
            <td style="color:#000000;">${c.bib_number}</td>
            <td style="color:#000000;">${name}</td>
            <td style="color:#000000;">${c.checkpoint}</td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('éæ¿¾æ‰“å¡è¨˜éŒ„å¤±æ•—:', error);
      }
    }

    function setMode(mode, event) {
      rankingMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      refreshData();
    }

    function formatTime(seconds) {
      if (!seconds || seconds < 0) return '00:00:00';
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      return [
        hours.toString().padStart(2, '0'),
        minutes.toString().padStart(2, '0'),
        secs.toString().padStart(2, '0')
      ].join(':');
    }

    function logMessage(message) {
      const timestamp = new Date().toLocaleTimeString('zh-HK');
      const logEntry = `[${timestamp}] ${message}`;
      
      // æ›´æ–°æ‰€æœ‰é é¢çš„æ—¥èªŒ
      const logs = ['overview-log', 'ranking-log', 'checkins-log'];
      logs.forEach(logId => {
        const logElement = document.getElementById(logId);
        if (logElement) {
          logElement.textContent = logEntry + '\n' + logElement.textContent;
          // åªä¿ç•™æœ€å¾Œ10æ¢è¨˜éŒ„
          const lines = logElement.textContent.split('\n');
          if (lines.length > 10) {
            logElement.textContent = lines.slice(0, 10).join('\n');
          }
        }
      });
    }

    async function loadParticipants() {
      if (!adminClient) return;
      
      try {
        const { data } = await adminClient
          .from('participants')
          .select('*')
          .order('bib_number');
        
        const tableBody = document.getElementById('participantsTableBody');
        tableBody.innerHTML = '';
        
        if (data && data.length > 0) {
          data.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td style="color:#000000;">${user.bib_number}</td>
              <td style="color:#000000;">${user.name}</td>
              <td style="text-align:center;">
                <button onclick="deleteUser('${user.bib_number}')" style="background: #ef4444; padding: 4px 8px; font-size: 12px;">ğŸ—‘ï¸ åˆªé™¤</button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        } else {
          tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#000000;">æš«ç„¡åƒè³½è€…</td></tr>';
        }
      } catch (error) {
        console.error('åŠ è¼‰åƒè³½è€…å¤±æ•—:', error);
        alert('åŠ è¼‰åƒè³½è€…å¤±æ•—: ' + error.message);
      }
    }

    async function addSingleUser() {
      const bibNumber = document.getElementById('manualBibNumber').value.trim();
      const name = document.getElementById('manualName').value.trim();
      
      if (!bibNumber || !name) {
        alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
        return;
      }
      
      try {
        const { error } = await adminClient
          .from('participants')
          .upsert({ bib_number: bibNumber, name });
        
        if (error) throw error;
        
        alert('åƒè³½è€…å·²æ·»åŠ /æ›´æ–°');
        document.getElementById('manualBibNumber').value = '';
        document.getElementById('manualName').value = '';
        await loadParticipants();
        refreshData();
      } catch (error) {
        console.error('æ·»åŠ åƒè³½è€…å¤±æ•—:', error);
        alert('æ·»åŠ å¤±æ•—: ' + error.message);
      }
    }

    async function deleteUser(bibNumber) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤åƒè³½è€… ${bibNumber} å—ï¼Ÿ`)) return;
      
      try {
        // å…ˆåˆªé™¤ç›¸é—œæ‰“å¡è¨˜éŒ„
        await adminClient
          .from('checkins')
          .delete()
          .eq('bib_number', bibNumber);
        
        // å†åˆªé™¤åƒè³½è€…
        const { error } = await adminClient
          .from('participants')
          .delete()
          .eq('bib_number', bibNumber);
        
        if (error) throw error;
        
        alert('åƒè³½è€…å·²åˆªé™¤');
        await loadParticipants();
        refreshData();
      } catch (error) {
        console.error('åˆªé™¤åƒè³½è€…å¤±æ•—:', error);
        alert('åˆªé™¤å¤±æ•—: ' + error.message);
      }
    }

    async function importFromCSV() {
      const fileInput = document.getElementById('csvFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('è«‹é¸æ“‡CSVæª”æ¡ˆ');
        return;
      }
      
      const statusElement = document.getElementById('csvImportStatus');
      statusElement.textContent = 'æ­£åœ¨è™•ç†...';
      
      try {
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim());
        const users = [];
        
        lines.forEach((line, index) => {
          const [bibNumber, name] = line.split(',').map(item => item.trim());
          if (bibNumber && name) {
            users.push({ bib_number: bibNumber, name });
          } else {
            statusElement.textContent += `\nç¬¬ ${index + 1} è¡Œæ ¼å¼éŒ¯èª¤: ${line}`;
          }
        });
        
        if (users.length === 0) {
          statusElement.textContent = 'æ²’æœ‰æœ‰æ•ˆçš„åƒè³½è€…æ•¸æ“š';
          return;
        }
        
        // æ‰¹é‡æ’å…¥/æ›´æ–°
        const { error } = await adminClient
          .from('participants')
          .upsert(users);
        
        if (error) throw error;
        
        statusElement.textContent = `æˆåŠŸå°å…¥ ${users.length} ååƒè³½è€…`;
        fileInput.value = '';
        await loadParticipants();
        refreshData();
        
      } catch (error) {
        console.error('CSVå°å…¥å¤±æ•—:', error);
        statusElement.textContent = 'å°å…¥å¤±æ•—: ' + error.message;
      }
    }

    async function clearAllData() {
      if (!confirm('âš ï¸ è­¦å‘Šï¼é€™å°‡åˆªé™¤æ‰€æœ‰åƒè³½è€…å’Œæ‰“å¡è¨˜éŒ„ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) return;
      if (!confirm('äºŒæ¬¡ç¢ºèªï¼šç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) return;
      
      try {
        // å…ˆåˆªé™¤æ‰“å¡è¨˜éŒ„
        await adminClient.from('checkins').delete().neq('id', '');
        // å†åˆªé™¤åƒè³½è€…
        await adminClient.from('participants').delete().neq('bib_number', '');
        
        alert('æ‰€æœ‰æ•¸æ“šå·²æ¸…ç©º');
        await loadParticipants();
        refreshData();
      } catch (error) {
        console.error('æ¸…ç©ºæ•¸æ“šå¤±æ•—:', error);
        alert('æ¸…ç©ºå¤±æ•—: ' + error.message);
      }
    }

    // ä¿®å¾©å¾Œçš„CSVåŒ¯å‡ºå‡½æ•¸ - è§£æ±ºfield.includes is not a functionéŒ¯èª¤
    async function exportCSV() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£ç·šæ•¸æ“šåº«');
        return;
      }
      
      try {
        // ç²å–æ‰€æœ‰åƒè³½è€…æ•¸æ“š
        const { data: participants } = await adminClient
          .from('participants')
          .select('bib_number, name');
        
        if (!participants || participants.length === 0) {
          alert('æ²’æœ‰åƒè³½è€…æ•¸æ“šå¯åŒ¯å‡º');
          return;
        }
        
        // ç²å–æ‰€æœ‰èµ·é»å’Œçµ‚é»è¨˜éŒ„
        const { data: startCheckins } = await adminClient
          .from('checkins')
          .select('bib_number, time')
          .eq('checkpoint', 'START');
        
        const { data: finishCheckins } = await adminClient
          .from('checkins')
          .select('bib_number, time')
          .eq('checkpoint', 'FINISH');
        
        // å‰µå»ºæ™‚é–“æ˜ å°„ï¼ˆå–æœ€æ—©çš„èµ·é»æ™‚é–“ï¼Œæœ€æ—©çš„çµ‚é»æ™‚é–“ï¼‰
        const startMap = new Map();
        if (startCheckins) {
          startCheckins.forEach(c => {
            if (!startMap.has(c.bib_number) || new Date(c.time) < new Date(startMap.get(c.bib_number))) {
              startMap.set(c.bib_number, c.time);
            }
          });
        }
        
        const finishMap = new Map();
        if (finishCheckins) {
          finishCheckins.forEach(c => {
            if (!finishMap.has(c.bib_number) || new Date(c.time) < new Date(finishMap.get(c.bib_number))) {
              finishMap.set(c.bib_number, c.time);
            }
          });
        }
        
        // æº–å‚™åŒ¯å‡ºæ•¸æ“š
        const exportData = participants.map(participant => {
          const startTime = startMap.get(participant.bib_number);
          const finishTime = finishMap.get(participant.bib_number);
          
          // æ ¼å¼åŒ–æ™‚é–“
          const formatDate = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-HK', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
          };
          
          // è¨ˆç®—ç”¨æ™‚
          let duration = '';
          if (startTime && finishTime) {
            const diffSeconds = (new Date(finishTime).getTime() - new Date(startTime).getTime()) / 1000;
            duration = formatTime(diffSeconds);
          }
          
          return {
            bib_number: participant.bib_number,
            name: participant.name,
            start_time: formatDate(startTime),
            finish_time: formatDate(finishTime),
            duration: duration
          };
        }).filter(item => item.start_time); // åªåŒ¯å‡ºæœ‰èµ·è·‘æ™‚é–“çš„é¸æ‰‹
        
        // æŒ‰çµ‚é»æ™‚é–“æ’åºï¼ˆæ¨¡æ“¬æ’åï¼‰
        exportData.sort((a, b) => {
          if (a.finish_time && b.finish_time) {
            return new Date(a.finish_time) - new Date(b.finish_time);
          } else if (a.finish_time) {
            return -1;
          } else if (b.finish_time) {
            return 1;
          } else {
            return new Date(a.start_time) - new Date(b.start_time);
          }
        });
        
        // å»ºç«‹CSVå…§å®¹ - ä¿®å¾©includeséŒ¯èª¤ï¼šå…ˆå°‡æ‰€æœ‰æ¬„ä½è½‰ç‚ºå­—ä¸²
        let csvContent = 'æ’å,è™Ÿç¢¼,å§“å,èµ·è·‘æ™‚é–“,å®Œè³½æ™‚é–“,ç”¨æ™‚\n';
        
        exportData.forEach((item, index) => {
          const row = [
            (index + 1).toString(), // æ’å - è½‰ç‚ºå­—ä¸²
            item.bib_number.toString(), // è™Ÿç¢¼ - è½‰ç‚ºå­—ä¸²
            item.name.toString(), // å§“å - è½‰ç‚ºå­—ä¸²
            item.start_time.toString(), // èµ·è·‘æ™‚é–“ - è½‰ç‚ºå­—ä¸²
            item.finish_time.toString(), // å®Œè³½æ™‚é–“ - è½‰ç‚ºå­—ä¸²
            item.duration.toString() // ç”¨æ™‚ - è½‰ç‚ºå­—ä¸²
          ].map(field => {
            // è™•ç†åŒ…å«é€—è™Ÿçš„æ¬„ä½ï¼Œç”¨å¼•è™ŸåŒ…èµ·ä¾†
            const strField = String(field); // ç¢ºä¿æ˜¯å­—ä¸²
            return strField.includes(',') ? `"${strField}"` : strField;
          }).join(',');
          
          csvContent += row + '\n';
        });
        
        // å‰µå»ºä¸¦ä¸‹è¼‰CSVæª”æ¡ˆ
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM for Chinese encoding
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        link.href = url;
        link.download = `è³½äº‹æˆç¸¾_${new Date().toLocaleDateString('zh-HK').replace(/\//g, '-')}.csv`;
        link.click();
        
        // é‡‹æ”¾URLç‰©ä»¶
        URL.revokeObjectURL(url);
        
        logMessage(`ğŸ’¾ å·²åŒ¯å‡º ${exportData.length} ååƒè³½è€…çš„æˆç¸¾æ•¸æ“š`);
        alert(`æˆåŠŸåŒ¯å‡º ${exportData.length} ååƒè³½è€…çš„æˆç¸¾æ•¸æ“š`);
        
      } catch (error) {
        console.error('åŒ¯å‡ºCSVå¤±æ•—:', error);
        alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
      }
    }

    function showManageUsersModal() {
      document.getElementById('manageUsersModal').style.display = 'flex';
      loadParticipants();
    }

    function hideManageUsersModal() {
      document.getElementById('manageUsersModal').style.display = 'none';
    }

    // é˜²æ­¢é»æ“Šæ¨¡æ…‹æ¡†èƒŒæ™¯é—œé–‰
    document.getElementById('manageUsersModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideManageUsersModal();
      }
    });
  </script>
</body>
</html>
