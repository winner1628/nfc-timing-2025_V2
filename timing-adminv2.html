<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š NFC è¨ˆæ™‚å¾Œå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: white; /* æ›´æ”¹ç‚ºç™½è‰²èƒŒæ™¯ */
      color: #333; /* æ›´æ”¹ç‚ºé»‘è‰²æ–‡å­— */
      padding: 20px; 
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    input { padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; width: 300px; margin-right: 12px; }
    button { padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { background: #2563eb; }
    .controls { margin: 20px 0; }
    .mode-toggle { display: inline-block; margin-right: 20px; font-size: 18px; font-weight: bold; }
    .mode-btn { padding: 8px 16px; margin: 0 4px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
    .active { background: #10b981; color: white; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    th, td { padding: 16px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f1f5f9; font-weight: bold; }
    .gold { background: #fef3c7; } .silver { background: #e0f2fe; } .bronze { background: #fed7aa; }
    #log { background: #f8f9fa; padding: 20px; border-radius: 12px; max-height: 200px; overflow-y: auto; font-family: monospace; }
    .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
    .stat-number { font-size: 36px; font-weight: bold; color: #3b82f6; }
    .stat-label { color: #64748b; margin-top: 8px; }
    .chart-container { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 24px; width: 25%; margin-left: auto; margin-right: auto; }
    
    /* é é¢å°èˆªæ¨£å¼ */
    .nav {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .nav-btn {
      padding: 8px 16px;
      background: #f5f5f5;
      color: #333;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .nav-btn.active {
      background: #667eea;
      color: white;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š NFC è·‘æ‰‹è¨ˆæ™‚å¾Œå°</h1>
      <div>
        <input id="adminUrl" placeholder="https://wceywyxwyygbwfodjdpp.supabase.co" value="YOUR_SUPABASE_URL" style="display: none;">
        <input id="adminKey" placeholder="sb_publishable_BWBxXzGk8bRGql3VbkCqbA_IZOfH5rc" type="password" value="YOUR_SUPABASE_KEY" style="display: none;">
        <button onclick="connectAdmin()">ğŸ”— é€£ç·šå¾Œå°</button>
        <button onclick="exportCSV()" style="background: #10b981; float: right; margin-left: 8px;">ğŸ’¾ åŒ¯å‡º CSV</button>
        <button onclick="showManageUsersModal()" style="background: #6366f1; float: right; margin-left: 8px;">ğŸ‘¥ ç®¡ç†åƒè³½è€…</button>
        <button onclick="clearAllData()" style="background: #ef4444; float: right;">ğŸ—‘ï¸ æ¸…ç©ºæ•¸æ“š</button>
      </div>
      <div id="status" style="margin-top: 12px; padding: 8px; border-radius: 8px; font-weight: bold;">æœªé€£ç·š</div>
    </div>
    
    <!-- é é¢å°èˆª -->
    <div class="nav">
      <button class="nav-btn active" data-page="dashboard">ç¸½è¦½</button>
      <button class="nav-btn" data-page="ranking">æ’åæ¨¡å¼</button>
      <button class="nav-btn" data-page="recent">æœ€æ–°æ‰“å¡ç´€éŒ„</button>
      <button class="nav-btn" data-page="settings">æ¯”è³½è¨­å®š</button>
    </div>
    
    <!-- ç¸½è¦½é é¢ -->
    <div id="dashboard-page" class="page active">
      <div class="dashboard" id="dashboard" style="display: none;">
        <div class="stat-card">
          <div class="stat-number" id="totalRunners">0</div>
          <div class="stat-label">ç¸½åƒè³½äººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="startedRunners">0</div>
          <div class="stat-label">å·²å‡ºç™¼äººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="finishedRunners">0</div>
          <div class="stat-label">å·²å®Œè³½äººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgTime">00:00</div>
          <div class="stat-label">å¹³å‡å®Œè³½æ™‚é–“</div>
        </div>
      </div>
      
      <div class="chart-container" id="progressChart" style="display: none;">
        <h3>ğŸ“ˆ æ¯”è³½é€²åº¦</h3>
        <canvas id="progressChartCanvas" width="400" height="200"></canvas>
      </div>
      
      <div class="controls">
        <div class="mode-toggle">
          ğŸ† æ’åæ¨¡å¼: 
          <button class="mode-btn active" onclick="setMode('gun', event)">ğŸ¯ çµ‚é»å…ˆå¾Œ</button>
          <button class="mode-btn" onclick="setMode('chip', event)">â±ï¸ å¯¦éš›ç”¨æ™‚</button>
        </div>
        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°è³‡æ–™</button>
      </div>
      
      <table id="resultsTable">
        <thead>
          <tr>
            <th>æ’å</th>
            <th>è™Ÿç¢¼</th>
            <th>å§“å</th>
            <th>èµ·è·‘æ™‚é–“</th>
            <th>å®Œè³½æ™‚é–“</th>
            <th>ç”¨æ™‚</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- æ’åæ¨¡å¼é é¢ -->
    <div id="ranking-page" class="page">
      <h2>æ’åæ¨¡å¼</h2>
      <div class="controls">
        <div class="mode-toggle">
          æ’åæ–¹å¼: 
          <button class="mode-btn active" onclick="setRankingMode('gun')">çµ‚é»åˆ°é”é †åº</button>
          <button class="mode-btn" onclick="setRankingMode('chip')">æ·¨ç”¨æ™‚æ’å</button>
        </div>
        <button onclick="refreshRankingData()">ğŸ”„ åˆ·æ–°æ’å</button>
      </div>
      <table id="rankingTable">
        <thead>
          <tr>
            <th>æ’å</th>
            <th>è™Ÿç¢¼</th>
            <th>å§“å</th>
            <th>å„æª¢æŸ¥é»æ™‚é–“</th>
            <th>ç¸½ç”¨æ™‚</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- æœ€æ–°æ‰“å¡ç´€éŒ„é é¢ -->
    <div id="recent-page" class="page">
      <h2>æœ€æ–°æ‰“å¡ç´€éŒ„</h2>
      <div class="controls">
        <select id="checkpoint-filter">
          <option value="all">æ‰€æœ‰æª¢æŸ¥é»</option>
          <!-- å‹•æ…‹åŠ è¼‰æª¢æŸ¥é»é¸é … -->
        </select>
        <button onclick="refreshRecentData()">ğŸ”„ åˆ·æ–°è¨˜éŒ„</button>
      </div>
      <table id="recentEventsTable">
        <thead>
          <tr>
            <th>æ™‚é–“</th>
            <th>è™Ÿç¢¼</th>
            <th>å§“å</th>
            <th>æª¢æŸ¥é»</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- æ¯”è³½è¨­å®šé é¢ -->
    <div id="settings-page" class="page">
      <h2>æ¯”è³½è¨­å®š</h2>
      <input type="text" id="race-name" placeholder="è¼¸å…¥æ¯”è³½åç¨±">
      
      <div>
        <label>æª¢æŸ¥é»æ•¸é‡ (2-10): </label>
        <input type="number" id="checkpoint-count" min="2" max="10" value="2">
      </div>
      
      <div id="checkpoint-names-container">
        <div class="checkpoint-name">
          <label>æª¢æŸ¥é» 1: </label>
          <input type="text" value="èµ·é»" class="checkpoint-input">
        </div>
        <div class="checkpoint-name">
          <label>æª¢æŸ¥é» 2: </label>
          <input type="text" value="çµ‚é»" class="checkpoint-input">
        </div>
      </div>
      
      <button id="save-settings" onclick="saveRaceSettings()">ä¿å­˜è¨­å®š</button>
      <div id="settings-status" style="margin-top: 12px; padding: 8px;"></div>
    </div>
    
    <div style="margin-top: 24px;">
      <h3>ğŸ“ æœ€æ–°æ‰“å¡è¨˜éŒ„</h3>
      <div id="log"></div>
    </div>
  </div>

  <!-- ç®¡ç†åƒè³½è€…æ¨¡æ…‹æ¡† -->
  <div id="manageUsersModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 16px; padding: 32px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2>ğŸ‘¥ ç®¡ç†åƒè³½è€…</h2>
        <button onclick="hideManageUsersModal()" style="background: #64748b; padding: 8px 16px;">âœ• é—œé–‰</button>
      </div>
      
      <!-- CSV å°å…¥åŠŸèƒ½ -->
      <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 12px;">
        <h3>ğŸ“ å¾ CSV å°å…¥åƒè³½è€…</h3>
        <p style="color: #64748b; margin-bottom: 16px;">CSV æ ¼å¼ï¼šè™Ÿç¢¼,å§“åï¼ˆä¾‹å¦‚ï¼š001,å¼µä¸‰ï¼‰</p>
        <input type="file" id="csvFileInput" accept=".csv" style="margin-bottom: 16px;">
        <button onclick="importFromCSV()" style="background: #22c55e;">ğŸ“¥ å°å…¥ CSV</button>
        <div id="csvImportStatus" style="margin-top: 16px; font-family: monospace;"></div>
      </div>
      
      <!-- æ‰‹å‹•æ·»åŠ åƒè³½è€… -->
      <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 12px;">
        <h3>â• æ‰‹å‹•æ·»åŠ åƒè³½è€…</h3>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          <input id="manualBibNumber" placeholder="è™Ÿç¢¼ï¼ˆå¦‚ï¼š001ï¼‰" style="width: 150px;">
          <input id="manualName" placeholder="å§“å" style="flex: 1;">
          <button onclick="addSingleUser()" style="background: #3b82f6;">â• æ·»åŠ </button>
        </div>
      </div>
      
      <!-- åƒè³½è€…åˆ—è¡¨ -->
      <div>
        <h3>ğŸ“‹ åƒè³½è€…åˆ—è¡¨</h3>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
          <table id="participantsTable" style="width: 100%; border-radius: 8px;">
            <thead>
              <tr>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; background: #f1f5f9;">è™Ÿç¢¼</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; background: #f1f5f9;">å§“å</th>
                <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0; background: #f1f5f9;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="participantsTableBody">
              <!-- åƒè³½è€…æ•¸æ“šå°‡å‹•æ…‹åŠ è¼‰ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let adminClient = null;
    let rankingMode = 'gun';
    let progressChart = null;
    let currentRaceId = null;
    let checkpointNames = ['èµ·é»', 'çµ‚é»'];

    // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      // é é¢åˆ‡æ›åŠŸèƒ½
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const pageId = this.getAttribute('data-page');
          
          // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // æ›´æ–°é é¢é¡¯ç¤º
          document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
          document.getElementById(`${pageId}-page`).classList.add('active');
          
          // åŠ è¼‰å°æ‡‰é é¢æ•¸æ“š
          if (pageId === 'ranking' && adminClient) loadRankingData();
          if (pageId === 'recent' && adminClient) loadRecentEvents();
          if (pageId === 'settings' && adminClient) loadRaceSettings();
        });
      });

      // æª¢æŸ¥é»æ•¸é‡è®ŠåŒ–æ™‚å‹•æ…‹ç”Ÿæˆè¼¸å…¥æ¡†
      document.getElementById('checkpoint-count').addEventListener('input', function(e) {
        const count = parseInt(e.target.value);
        const container = document.getElementById('checkpoint-names-container');
        container.innerHTML = '';
        
        for (let i = 1; i <= count; i++) {
          const defaultName = i === 1 ? 'èµ·é»' : i === count ? 'çµ‚é»' : `CP${i-1}`;
          const div = document.createElement('div');
          div.className = 'checkpoint-name';
          div.innerHTML = `
            <label>æª¢æŸ¥é» ${i}: </label>
            <input type="text" value="${defaultName}" class="checkpoint-input">
          `;
          container.appendChild(div);
        }
      });

      // å˜—è©¦å¾æœ¬åœ°å­˜å„²åŠ è¼‰é€£æ¥ä¿¡æ¯
      const savedUrl = localStorage.getItem('nfc_admin_url');
      const savedKey = localStorage.getItem('nfc_admin_key');
      
      if (savedUrl && savedKey) {
        document.getElementById('adminUrl').value = savedUrl;
        document.getElementById('adminKey').value = savedKey;
        setTimeout(() => connectAdmin(), 1000);
      }
    });

    // é€£ç·šå¾Œå°
    async function connectAdmin() {
      const url = document.getElementById('adminUrl').value.trim();
      const key = document.getElementById('adminKey').value.trim();
      const status = document.getElementById('status');

      try {
        if (!url || !key) {
          alert('URL æˆ– Key ç„¡å¡«');
          return;
        }

        // ä¿å­˜é€£æ¥ä¿¡æ¯åˆ°æœ¬åœ°å­˜å„²
        localStorage.setItem('https://wceywyxwyygbwfodjdpp.supabase.co', url);
        localStorage.setItem('sb_publishable_BWBxXzGk8bRGql3VbkCqbA_IZOfH5rc', key);

        adminClient = window.supabase.createClient(url, key);

        status.textContent = 'é€£ç·šä¸­...';
        status.style.background = '#f59e0b';

        // æ¸¬è©¦é€£æ¥
        const { data, error } = await adminClient
          .from('participants')
          .select('*')
          .limit(1);

        if (error) throw new Error('è®€å– participants å‡ºéŒ¯ï¼š' + error.message);

        status.textContent = 'âœ… å¾Œå°å·²é€£ç·š';
        status.style.background = '#10b981';

        // é¡¯ç¤ºå„€è¡¨æ¿
        document.getElementById('dashboard').style.display = 'grid';
        document.getElementById('progressChart').style.display = 'block';

        // åŠ è¼‰æ•¸æ“š
        await refreshData();
        await loadRaceSettings();

      } catch (e) {
        console.error('é€£æ¥éŒ¯èª¤:', e);
        status.textContent = 'âŒ é€£ç·šå¤±æ•—';
        status.style.background = '#ef4444';
        alert('å¾Œå°é€£ç·šå¤±æ•—ï¼š' + (e.message || e.toString()));
      }
    }

    // åˆ·æ–°æ•¸æ“š
    async function refreshData() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£ç·šå¾Œå°');
        return;
      }

      try {
        // ç²å–ç•¶å‰æ¿€æ´»çš„æ¯”è³½è¨­ç½®
        const { data: raceSettings, error: raceError } = await adminClient
          .from('race_settings')
          .select('*')
          .eq('is_active', true)
          .single();
          
        if (raceSettings) {
          currentRaceId = raceSettings.race_id;
          checkpointNames = raceSettings.checkpoint_names;
        }

        // ç²å–æ‰€æœ‰äº‹ä»¶æ•¸æ“š
        const { data: events, error: e1 } = await adminClient
          .from('events')
          .select('*')
          .order('timestamp', { ascending: true });
        
        if (e1) throw new Error('è®€ events å‡ºéŒ¯ï¼š' + e1.message);

        // ç²å–æ‰€æœ‰åƒè³½è€…æ•¸æ“š
        const { data: participants, error: e2 } = await adminClient
          .from('participants')
          .select('*');
        
        if (e2) throw new Error('è®€ participants å‡ºéŒ¯ï¼š' + e2.message);

        // é¡¯ç¤ºçµæœå’Œæ—¥èªŒ
        displayResults(events, participants);
        logRecentEvents(events);
        updateDashboard(events, participants);
        updateProgressChart(events, participants);

      } catch (e) {
        console.error('åˆ·æ–°æ•¸æ“šéŒ¯èª¤:', e);
        alert('åˆ·æ–°æ•¸æ“šå‡ºéŒ¯ï¼š' + e.message);
      }
    }

    // ä¿å­˜æ¯”è³½è¨­ç½®
    async function saveRaceSettings() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£ç·šå¾Œå°');
        return;
      }

      try {
        const raceName = document.getElementById('race-name').value;
        const checkpointCount = parseInt(document.getElementById('checkpoint-count').value);
        const checkpointInputs = document.querySelectorAll('.checkpoint-input');
        const checkpointNames = Array.from(checkpointInputs).map(input => input.value);
        
        if (!raceName) {
          alert('è«‹è¼¸å…¥æ¯”è³½åç¨±');
          return;
        }

        // å°‡æ‰€æœ‰æ¯”è³½æ¨™è¨˜ç‚ºéæ¿€æ´»
        await adminClient
          .from('race_settings')
          .update({ is_active: false })
          .eq('is_active', true);

        // æ’å…¥æ–°çš„æ¯”è³½è¨­ç½®
        const { data, error } = await adminClient
          .from('race_settings')
          .insert([{
            race_name: raceName,
            checkpoint_count: checkpointCount,
            checkpoint_names: checkpointNames,
            is_active: true
          }]);

        if (error) throw error;

        document.getElementById('settings-status').textContent = 'âœ… è¨­å®šä¿å­˜æˆåŠŸ';
        document.getElementById('settings-status').style.background = '#10b981';
        
        // æ›´æ–°ç•¶å‰æ¯”è³½ID
        currentRaceId = data[0].race_id;
        
        // é‡æ–°åŠ è¼‰æ•¸æ“š
        setTimeout(() => refreshData(), 1000);

      } catch (e) {
        console.error('ä¿å­˜è¨­ç½®éŒ¯èª¤:', e);
        document.getElementById('settings-status').textContent = 'âŒ ä¿å­˜å¤±æ•—: ' + e.message;
        document.getElementById('settings-status').style.background = '#ef4444';
      }
    }

    // åŠ è¼‰æ¯”è³½è¨­ç½®
    async function loadRaceSettings() {
      if (!adminClient) return;

      try {
        const { data, error } = await adminClient
          .from('race_settings')
          .select('*')
          .eq('is_active', true)
          .single();

        if (error) {
          console.log('æ²’æœ‰æ‰¾åˆ°æ¿€æ´»çš„æ¯”è³½è¨­ç½®ï¼Œä½¿ç”¨é»˜èªå€¼');
          return;
        }

        document.getElementById('race-name').value = data.race_name;
        document.getElementById('checkpoint-count').value = data.checkpoint_count;
        
        // æ›´æ–°æª¢æŸ¥é»è¼¸å…¥æ¡†
        const container = document.getElementById('checkpoint-names-container');
        container.innerHTML = '';
        
        data.checkpoint_names.forEach((name, index) => {
          const div = document.createElement('div');
          div.className = 'checkpoint-name';
          div.innerHTML = `
            <label>æª¢æŸ¥é» ${index + 1}: </label>
            <input type="text" value="${name}" class="checkpoint-input">
          `;
          container.appendChild(div);
        });

        // æ›´æ–°æª¢æŸ¥é»éæ¿¾å™¨
        const filter = document.getElementById('checkpoint-filter');
        filter.innerHTML = '<option value="all">æ‰€æœ‰æª¢æŸ¥é»</option>';
        data.checkpoint_names.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          filter.appendChild(option);
        });

        checkpointNames = data.checkpoint_names;
        currentRaceId = data.race_id;

      } catch (e) {
        console.error('åŠ è¼‰æ¯”è³½è¨­ç½®éŒ¯èª¤:', e);
      }
    }

    // åŠ è¼‰æ’åæ•¸æ“š
    async function loadRankingData() {
      if (!adminClient) return;

      try {
        const { data: events, error: e1 } = await adminClient
          .from('events')
          .select('*')
          .order('timestamp', { ascending: true });
        
        const { data: participants, error: e2 } = await adminClient
          .from('participants')
          .select('*');

        if (e1 || e2) throw new Error('åŠ è¼‰æ•¸æ“šå‡ºéŒ¯');

        // è™•ç†æ’åæ•¸æ“š
        const bibStats = {};

        events.forEach(event => {
          if (!bibStats[event.bib_number]) {
            bibStats[event.bib_number] = {
              bib_number: event.bib_number,
              name: (participants.find(p => p.bib_number === event.bib_number) || {}).name || 'æœªçŸ¥',
              checkpoints: {}
            };
          }
          bibStats[event.bib_number].checkpoints[event.checkpoint] = event.timestamp;
        });

        // è¨ˆç®—å„æª¢æŸ¥é»ä¹‹é–“çš„æ™‚é–“
        Object.values(bibStats).forEach(runner => {
          // æŒ‰é †åºæ’åˆ—æª¢æŸ¥é»æ™‚é–“
          const checkpoints = [];
          checkpointNames.forEach(name => {
            if (runner.checkpoints[name]) {
              checkpoints.push({
                name,
                time: runner.checkpoints[name]
              });
            }
          });

          // è¨ˆç®—å€æ®µæ™‚é–“
          let totalDuration = 0;
          for (let i = 1; i < checkpoints.length; i++) {
            const prev = new Date(checkpoints[i-1].time);
            const curr = new Date(checkpoints[i].time);
            const duration = curr - prev;
            
            if (duration < 0) duration += 24 * 60 * 60 * 1000; // è™•ç†è·¨å¤©
            totalDuration += duration;
            
            runner[`duration_${checkpoints[i-1].name}_to_${checkpoints[i].name}`] = duration;
          }

          runner.total_duration = totalDuration;
          runner.formatted_total = formatDuration(totalDuration);
          runner.last_checkpoint_time = checkpoints.length > 0 
            ? checkpoints[checkpoints.length - 1].time 
            : null;
        });

        // æ’åº
        let sortedRunners;
        if (rankingMode === 'gun') {
          sortedRunners = Object.values(bibStats)
            .filter(r => r.last_checkpoint_time)
            .sort((a, b) => new Date(a.last_checkpoint_time) - new Date(b.last_checkpoint_time));
        } else {
          sortedRunners = Object.values(bibStats)
            .filter(r => r.total_duration)
            .sort((a, b) => a.total_duration - b.total_duration);
        }

        // æ›´æ–°æ’åè¡¨æ ¼
        const tbody = document.querySelector('#rankingTable tbody');
        tbody.innerHTML = '';

        sortedRunners.forEach((runner, index) => {
          const row = tbody.insertRow();
          row.className = index < 3 ? ['gold', 'silver', 'bronze'][index] : '';

          // æ ¼å¼åŒ–æª¢æŸ¥é»æ™‚é–“
          let checkpointsHtml = '';
          checkpointNames.forEach(name => {
            checkpointsHtml += `${name}: ${runner.checkpoints[name] ? formatDateTime(runner.checkpoints[name]) : '-'}</br>`;
          });

          row.innerHTML = `
            <td>${index + 1} ${index < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] : ''}</td>
            <td>${runner.bib_number}</td>
            <td>${runner.name}</td>
            <td>${checkpointsHtml}</td>
            <td>${runner.formatted_total || '-'}</td>
          `;
        });

      } catch (e) {
        console.error('åŠ è¼‰æ’åæ•¸æ“šéŒ¯èª¤:', e);
      }
    }

    // åŠ è¼‰æœ€æ–°æ‰“å¡è¨˜éŒ„
    async function loadRecentEvents() {
      if (!adminClient) return;

      try {
        const checkpointFilter = document.getElementById('checkpoint-filter').value;
        
        let query = adminClient
          .from('events')
          .select('*, participants(name)', { count: 'exact' })
          .order('timestamp', { ascending: false })
          .limit(50);

        // æ‡‰ç”¨éæ¿¾å™¨
        if (checkpointFilter !== 'all') {
          query = query.eq('checkpoint', checkpointFilter);
        }

        const { data: events, error } = await query;

        if (error) throw error;

        // æ›´æ–°è¡¨æ ¼
        const tbody = document.querySelector('#recentEventsTable tbody');
        tbody.innerHTML = '';

        events.forEach(event => {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${formatDateTime(event.timestamp)}</td>
            <td>${event.bib_number}</td>
            <td>${event.participants?.name || 'æœªçŸ¥'}</td>
            <td>${event.checkpoint}</td>
          `;
        });

      } catch (e) {
        console.error('åŠ è¼‰æœ€æ–°è¨˜éŒ„éŒ¯èª¤:', e);
      }
    }

    // é¡¯ç¤ºçµæœè¡¨æ ¼
    function displayResults(events, participants) {
      const bibStats = {};

      events.forEach(event => {
        if (!bibStats[event.bib_number]) {
          bibStats[event.bib_number] = {
            bib_number: event.bib_number,
            name: (participants.find(p => p.bib_number === event.bib_number) || {}).name || 'æœªçŸ¥',
            start_time: null,
            finish_time: null,
            duration_ms: null,
            duration: null
          };
        }
        
        // è¨­ç½®èµ·é»å’Œçµ‚é»æ™‚é–“
        if (event.checkpoint === checkpointNames[0]) {
          bibStats[event.bib_number].start_time = event.timestamp;
        } else if (event.checkpoint === checkpointNames[checkpointNames.length - 1]) {
          bibStats[event.bib_number].finish_time = event.timestamp;
        }
      });

      // è¨ˆç®—å®Œæˆæ™‚é–“
      Object.values(bibStats).forEach(runner => {
        if (runner.start_time && runner.finish_time) {
          const startTime = new Date(runner.start_time);
          const finishTime = new Date(runner.finish_time);
          
          if (finishTime >= startTime) {
            const duration = finishTime - startTime;
            runner.duration_ms = duration;
            runner.duration = formatDuration(duration);
          } else {
            const duration = (finishTime.getTime() + 24 * 60 * 60 * 1000) - startTime.getTime();
            runner.duration_ms = duration;
            runner.duration = formatDuration(duration);
          }
        }
      });

      // æ’åº
      let sortedRunners;
      if (rankingMode === 'gun') {
        sortedRunners = Object.values(bibStats)
          .filter(r => r.finish_time)
          .sort((a, b) => new Date(a.finish_time) - new Date(b.finish_time));
      } else {
        sortedRunners = Object.values(bibStats)
          .filter(r => r.duration_ms)
          .sort((a, b) => a.duration_ms - b.duration_ms);
      }

      // æ›´æ–°è¡¨æ ¼
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';

      sortedRunners.slice(0, 200).forEach((runner, index) => {
        const row = tbody.insertRow();
        row.className = index < 3 ? ['gold', 'silver', 'bronze'][index] : '';

        row.innerHTML = `
          <td>${index + 1} ${index < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] : ''}</td>
          <td>${runner.bib_number}</td>
          <td>${runner.name}</td>
          <td>${runner.start_time ? formatDateTime(runner.start_time) : '-'}</td>
          <td>${runner.finish_time ? formatDateTime(runner.finish_time) : '-'}</td>
          <td>${runner.duration || '-'}</td>
        `;
      });
    }

    // æ ¼å¼åŒ–æ™‚é–“å‡½æ•¸
    function formatDuration(ms) {
      if (typeof ms !== 'number' || isNaN(ms) || ms < 0) {
        return 'æ— æ•ˆæ—¶é—´';
      }
      
      const secs = Math.floor(ms / 1000);
      const mins = Math.floor(secs / 60);
      const hours = Math.floor(mins / 60);
      
      if (hours > 0) return hours + ':' + String(mins%60).padStart(2,'0') + ':' + String(secs%60).padStart(2,'0');
      if (mins > 0) return mins + ':' + String(secs%60).padStart(2,'0');
      return secs + 'ç§’';
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
    function formatDateTime(timestamp) {
      try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return 'æ— æ•ˆæ—¶é—´';
        
        const adjustedTime = new Date(date.getTime() + (8 * 60 * 60 * 1000));
        const year = adjustedTime.getFullYear();
        const month = String(adjustedTime.getMonth() + 1).padStart(2, '0');
        const day = String(adjustedTime.getDate()).padStart(2, '0');
        const hours = String(adjustedTime.getHours()).padStart(2, '0');
        const minutes = String(adjustedTime.getMinutes()).padStart(2, '0');
        const seconds = String(adjustedTime.getSeconds()).padStart(2, '0');
        
        return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
      } catch (error) {
        return `é”™è¯¯: ${error.message}`;
      }
    }

    // æ—¥èªŒæœ€æ–°äº‹ä»¶
    function logRecentEvents(events) {
      const recent = events.slice(-10).reverse();
      const log = document.getElementById('log');
      log.innerHTML = recent.map(e => {
        const adjustedTime = new Date(new Date(e.timestamp).getTime() + (8 * 60 * 60 * 1000));
        return `<span>
        âœ… ${e.bib_number} ${e.checkpoint} ${adjustedTime.toLocaleString('zh-HK')}
        </span>`;
      }).join('<br>');
    }

    // æ›´æ–°å„€è¡¨æ¿
    function updateDashboard(events, participants) {
      const totalRunners = participants.length;
      const startCheckpoint = checkpointNames[0];
      const finishCheckpoint = checkpointNames[checkpointNames.length - 1];
      
      const startedEvents = events.filter(e => e.checkpoint === startCheckpoint);
      const finishedEvents = events.filter(e => e.checkpoint === finishCheckpoint);
      
      // è¨ˆç®—å¹³å‡æ™‚é–“
      let totalDuration = 0;
      let validFinishCount = 0;
      
      participants.forEach(runner => {
        const startEvent = startedEvents.find(e => e.bib_number === runner.bib_number);
        const finishEvent = finishedEvents.find(e => e.bib_number === runner.bib_number);
        
        if (startEvent && finishEvent) {
          const startTime = new Date(startEvent.timestamp).getTime();
          const finishTime = new Date(finishEvent.timestamp).getTime();
          let duration = finishTime - startTime;
          
          if (duration < 0) duration += 24 * 60 * 60 * 1000;
          
          if (duration > 0 && duration < 24 * 60 * 60 * 1000) {
            totalDuration += duration;
            validFinishCount++;
          }
        }
      });
      
      const avgTime = validFinishCount > 0 ? totalDuration / validFinishCount : 0;
      
      // æ›´æ–°é¡¯ç¤º
      document.getElementById('totalRunners').textContent = totalRunners;
      document.getElementById('startedRunners').textContent = new Set(startedEvents.map(e => e.bib_number)).size;
      document.getElementById('finishedRunners').textContent = new Set(finishedEvents.map(e => e.bib_number)).size;
      document.getElementById('avgTime').textContent = avgTime ? formatDuration(avgTime) : '00:00';
    }

    // æ›´æ–°é€²åº¦åœ–è¡¨
    function updateProgressChart(events, participants) {
      const startCheckpoint = checkpointNames[0];
      const finishCheckpoint = checkpointNames[checkpointNames.length - 1];
      
      const started = new Set(events.filter(e => e.checkpoint === startCheckpoint).map(e => e.bib_number)).size;
      const finished = new Set(events.filter(e => e.checkpoint === finishCheckpoint).map(e => e.bib_number)).size;
      const total = participants.length;
      const inProgress = started - finished;
      
      const ctx = document.getElementById('progressChartCanvas').getContext('2d');
      
      if (progressChart) {
        progressChart.destroy();
      }
      
      progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['å·²å®Œæˆ', 'é€²è¡Œä¸­', 'æœªé–‹å§‹'],
          datasets: [{
            data: [finished, inProgress, total - started],
            backgroundColor: ['#10b981', '#3b82f6', '#94a3b8']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // è¨­ç½®æ’åæ¨¡å¼
    function setMode(mode, event) {
      rankingMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      refreshData();
    }

    // è¨­ç½®æ’åé é¢çš„æ’åæ¨¡å¼
    function setRankingMode(mode) {
      rankingMode = mode;
      document.querySelectorAll('#ranking-page .mode-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('#ranking-page .mode-btn').forEach(btn => {
        if (btn.onclick.toString().includes(mode)) {
          btn.classList.add('active');
        }
      });
      loadRankingData();
    }

    // åˆ·æ–°æ’åæ•¸æ“š
    function refreshRankingData() {
      loadRankingData();
    }

    // åˆ·æ–°æœ€æ–°è¨˜éŒ„
    function refreshRecentData() {
      loadRecentEvents();
    }

    // åŒ¯å‡ºCSV
    async function exportCSV() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£ç·šå¾Œå°');
        return;
      }

      try {
        const { data: events, error: e1 } = await adminClient.from('events').select('*');
        const { data: participants, error: e2 } = await adminClient.from('participants').select('*');
        
        if (e1 || e2) throw new Error('ç²å–æ•¸æ“šå¤±æ•—');

        // è™•ç†æ•¸æ“š
        const bibStats = {};
        events.forEach(event => {
          if (!bibStats[event.bib_number]) {
            bibStats[event.bib_number] = {
              bib_number: event.bib_number,
              name: (participants.find(p => p.bib_number === event.bib_number) || {}).name || 'æœªçŸ¥'
            };
          }
          bibStats[event.bib_number][event.checkpoint] = formatDateTime(event.timestamp);
        });

        // ç”ŸæˆCSV
        let csv = 'è™Ÿç¢¼,å§“å';
        checkpointNames.forEach(name => {
          csv += `,${name}`;
        });
        csv += '\n';

        Object.values(bibStats).forEach(runner => {
          csv += `${runner.bib_number},${runner.name}`;
          checkpointNames.forEach(name => {
            csv += `,${runner[name] || ''}`;
          });
          csv += '\n';
        });

        // ä¸‹è¼‰CSV
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `race_results_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

      } catch (e) {
        console.error('åŒ¯å‡ºCSVéŒ¯èª¤:', e);
        alert('åŒ¯å‡ºå¤±æ•—ï¼š' + e.message);
      }
    }

    // ç®¡ç†åƒè³½è€…ç›¸é—œå‡½æ•¸
    function showManageUsersModal() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£ç·šå¾Œå°');
        return;
      }
      document.getElementById('manageUsersModal').style.display = 'flex';
      loadParticipants();
    }

    function hideManageUsersModal() {
      document.getElementById('manageUsersModal').style.display = 'none';
    }

    async function loadParticipants() {
      try {
        const { data, error } = await adminClient
          .from('participants')
          .select('*')
          .order('bib_number');

        if (error) throw error;

        const tbody = document.getElementById('participantsTableBody');
        tbody.innerHTML = '';

        data.forEach(participant => {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${participant.bib_number}</td>
            <td>${participant.name}</td>
            <td>
              <button onclick="deleteParticipant('${participant.bib_number}')" style="background: #ef4444; padding: 4px 8px;">åˆªé™¤</button>
            </td>
          `;
        });

      } catch (e) {
        console.error('åŠ è¼‰åƒè³½è€…éŒ¯èª¤:', e);
      }
    }

    async function addSingleUser() {
      const bib = document.getElementById('manualBibNumber').value.trim();
      const name = document.getElementById('manualName').value.trim();

      if (!bib || !name) {
        alert('è«‹å¡«å¯«è™Ÿç¢¼å’Œå§“å');
        return;
      }

      try {
        const { error } = await adminClient
          .from('participants')
          .insert([{ bib_number: bib, name: name }]);

        if (error) throw error;

        document.getElementById('manualBibNumber').value = '';
        document.getElementById('manualName').value = '';
        loadParticipants();
        refreshData();

      } catch (e) {
        console.error('æ·»åŠ åƒè³½è€…éŒ¯èª¤:', e);
        alert('æ·»åŠ å¤±æ•—ï¼š' + e.message);
      }
    }

    async function deleteParticipant(bib) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤è™Ÿç¢¼ ${bib} çš„åƒè³½è€…å—ï¼Ÿ`)) return;

      try {
        // å…ˆåˆªé™¤ç›¸é—œäº‹ä»¶
        await adminClient.from('events').delete().eq('bib_number', bib);
        
        // å†åˆªé™¤åƒè³½è€…
        const { error } = await adminClient
          .from('participants')
          .delete()
          .eq('bib_number', bib);

        if (error) throw error;

        loadParticipants();
        refreshData();

      } catch (e) {
        console.error('åˆªé™¤åƒè³½è€…éŒ¯èª¤:', e);
        alert('åˆªé™¤å¤±æ•—ï¼š' + e.message);
      }
    }

    async function importFromCSV() {
      const input = document.getElementById('csvFileInput');
      const status = document.getElementById('csvImportStatus');
      
      if (!input.files || input.files.length === 0) {
        alert('è«‹é¸æ“‡CSVæ–‡ä»¶');
        return;
      }

      const file = input.files[0];
      const reader = new FileReader();
      
      status.textContent = 'æ­£åœ¨å°å…¥...';
      
      reader.onload = async function(e) {
        try {
          const content = e.target.result;
          const lines = content.split('\n');
          const participants = [];
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const [bib, name] = line.split(',');
            if (bib && name) {
              participants.push({
                bib_number: bib.trim(),
                name: name.trim()
              });
            }
          }
          
          if (participants.length === 0) {
            status.textContent = 'âŒ æœªæ‰¾åˆ°æœ‰æ•ˆæ•¸æ“š';
            return;
          }
          
          // æ‰¹é‡æ’å…¥
          const { error } = await adminClient
            .from('participants')
            .insert(participants);
          
          if (error) throw error;
          
          status.textContent = `âœ… æˆåŠŸå°å…¥ ${participants.length} ååƒè³½è€…`;
          input.value = '';
          loadParticipants();
          refreshData();
          
        } catch (e) {
          console.error('CSVå°å…¥éŒ¯èª¤:', e);
          status.textContent = `âŒ å°å…¥å¤±æ•—: ${e.message}`;
        }
      };
      
      reader.readAsText(file);
    }

    async function clearAllData() {
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ¯”è³½æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ï¼')) return;

      try {
        // å…ˆåˆªé™¤äº‹ä»¶
        await adminClient.from('events').delete().neq('id', '');
        
        // ä¸åˆªé™¤åƒè³½è€…ï¼Œåªé‡ç½®æ¯”è³½æ•¸æ“š
        refreshData();
        alert('æ•¸æ“šå·²æ¸…ç©º');

      } catch (e) {
        console.error('æ¸…ç©ºæ•¸æ“šéŒ¯èª¤:', e);
        alert('æ¸…ç©ºå¤±æ•—ï¼š' + e.message);
      }
    }
  </script>
</body>
</html>
