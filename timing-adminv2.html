<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š NFC è¨ˆæ™‚å¾Œå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #ffffff; 
      color: #000000; 
      padding: 20px; 
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    input { padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; width: 300px; margin-right: 12px; }
    button { padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    button:hover { background: #2563eb; }
    .controls { margin: 20px 0; }
    .mode-toggle { display: inline-block; margin-right: 20px; font-size: 18px; font-weight: bold; }
    .mode-btn { padding: 8px 16px; margin: 0 4px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
    .active { background: #10b981; color: white; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    th, td { padding: 16px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f1f5f9; font-weight: bold; }
    .gold { background: #fef3c7; } .silver { background: #e0f2fe; } .bronze { background: #fed7aa; }
    #log { background: #f8f9fa; padding: 20px; border-radius: 12px; max-height: 200px; overflow-y: auto; font-family: monospace; color: #000000; }
    .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
    .stat-number { font-size: 36px; font-weight: bold; color: #3b82f6; }
    .stat-label { color: #64748b; margin-top: 8px; }
    .chart-container { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 24px; width: 25%; margin-left: auto; margin-right: auto; }
    
    /* å°èˆªæ¨£å¼ */
    .navigation { margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }
    .nav-btn { padding: 8px 16px; margin-right: 10px; background: #f1f5f9; color: #000000; }
    .nav-btn.active { background: #3b82f6; color: white; }
    
    /* é é¢å®¹å™¨æ¨£å¼ */
    .page { display: none; }
    .page.active { display: block; }
    
    /* ç¯©é¸å™¨æ¨£å¼ */
    .filters { margin: 16px 0; padding: 16px; background: #f8fafc; border-radius: 8px; }
    select, .filter-input { padding: 8px 12px; margin-right: 12px; border: 1px solid #e2e8f0; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š NFC è·‘æ‰‹è¨ˆæ™‚å¾Œå°</h1>
      <div>
        <input id="adminUrl" placeholder="https://wceywyxwyygbwfodjdpp.supabase.co" value="https://vzulldiiuguzobjcpikh.supabase.co" style="display: none;">
        <input id="adminKey" placeholder="sb_publishable_BWBxXzGk8bRGql3VbkCqbA_IZOfH5rc" type="password" value="sb_publishable_SBltOg1AOREur1bYWij2kg_BneOwzh4" style="display: none;">
        <button onclick="connectAdmin()">ğŸ”— é€£ç·šå¾Œå°</button>
        <button onclick="exportCSV()" style="background: #10b981; float: right; margin-left: 8px;">ğŸ’¾ åŒ¯å‡º CSV</button>
        <button onclick="showManageUsersModal()" style="background: #6366f1; float: right; margin-left: 8px;">ğŸ‘¥ ç®¡ç†åƒè³½è€…</button>
        <button onclick="clearAllData()" style="background: #ef4444; float: right;">ğŸ—‘ï¸ æ¸…ç©ºæ•¸æ“š</button>
      </div>
      <div id="status" style="margin-top: 12px; padding: 8px; border-radius: 8px; font-weight: bold;">æœªé€£ç·š</div>
    </div>
    
    <!-- é é¢å°èˆª -->
    <div class="navigation" id="navigation" style="display: none;">
      <button class="nav-btn active" onclick="showPage('overview')">ç¸½è¦½</button>
      <button class="nav-btn" onclick="showPage('ranking')">æ’åè©³æƒ…</button>
      <button class="nav-btn" onclick="showPage('checkins')">æ‰“å¡è¨˜éŒ„</button>
    </div>
    
    <!-- ç¸½è¦½é é¢ -->
    <div id="overview-page" class="page active">
      <div class="dashboard" id="dashboard" style="display: none;">
        <div class="stat-card">
          <div class="stat-number" id="totalRunners">0</div>
          <div class="stat-label">ç¸½åƒè³½äººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="startedRunners">0</div>
          <div class="stat-label">å·²å‡ºç™¼äººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="finishedRunners">0</div>
          <div class="stat-label">å·²å®Œè³½äººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgTime">00:00</div>
          <div class="stat-label">å¹³å‡å®Œè³½æ™‚é–“</div>
        </div>
      </div>
      
      <div class="chart-container" id="progressChart" style="display: none;">
        <h3>ğŸ“ˆ æ¯”è³½é€²åº¦</h3>
        <canvas id="progressChartCanvas" width="400" height="200"></canvas>
      </div>
      
      <div class="controls">
        <div class="mode-toggle">
          ğŸ† æ’åæ¨¡å¼: 
          <button class="mode-btn active" onclick="setMode('gun', event)">ğŸ¯ çµ‚é»å…ˆå¾Œ</button>
          <button class="mode-btn" onclick="setMode('chip', event)">â±ï¸ å¯¦éš›ç”¨æ™‚</button>
          <button class="mode-btn" onclick="setMode('split', event)">ğŸ“Š åˆ†æ®µæˆç¸¾</button>
        </div>
        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°è³‡æ–™</button>
      </div>
      
      <table id="resultsTable">
        <thead>
          <tr>
            <th>æ’å</th>
            <th>è™Ÿç¢¼</th>
            <th>å§“å</th>
            <th>èµ·è·‘æ™‚é–“</th>
            <th>å®Œè³½æ™‚é–“</th>
            <th>ç”¨æ™‚</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- æ’åè©³æƒ…é  -->
    <div id="ranking-page" class="page">
      <h2>ğŸ† æ’åè©³æƒ…</h2>
      <div class="filters">
        <select id="rankingCheckpointFilter" onchange="refreshData()">
          <option value="all">æ‰€æœ‰æª¢æŸ¥é»</option>
          <!-- å‹•æ…‹å¡«å……æª¢æŸ¥é»é¸é … -->
        </select>
        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ’å</button>
      </div>
      <div class="mode-toggle">
        æ’åæ¨¡å¼: 
        <button class="mode-btn active" onclick="setMode('gun', event)">ğŸ¯ æŒ‰çµ‚é»æ™‚é–“</button>
        <button class="mode-btn" onclick="setMode('chip', event)">â±ï¸ æŒ‰å¯¦éš›ç”¨æ™‚</button>
        <button class="mode-btn" onclick="setMode('split', event)">ğŸ“Š æŒ‰åˆ†æ®µæˆç¸¾</button>
      </div>
      <table id="detailedRankingTable">
        <thead>
          <tr>
            <th>æ’å</th>
            <th>è™Ÿç¢¼</th>
            <th>å§“å</th>
            <th>å„æª¢æŸ¥é»æ™‚é–“</th>
            <th>ç¸½ç”¨æ™‚</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- æ‰“å¡è¨˜éŒ„é  -->
    <div id="checkins-page" class="page">
      <h2>ğŸ“ æ‰“å¡è¨˜éŒ„</h2>
      <div class="filters">
        <select id="checkpointFilter" onchange="filterCheckins()">
          <option value="all">æ‰€æœ‰æª¢æŸ¥é»</option>
          <!-- å‹•æ…‹å¡«å……æª¢æŸ¥é»é¸é … -->
        </select>
        <input type="text" id="bibFilter" placeholder="æœç´¢è™Ÿç¢¼" class="filter-input" oninput="filterCheckins()">
        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°è¨˜éŒ„</button>
      </div>
      <table id="checkinsTable">
        <thead>
          <tr>
            <th>æ™‚é–“</th>
            <th>è™Ÿç¢¼</th>
            <th>å§“å</th>
            <th>æª¢æŸ¥é»</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div style="margin-top: 24px;">
      <h3>ğŸ“ æœ€æ–°æ‰“å¡è¨˜éŒ„</h3>
      <div id="log"></div>
    </div>
  </div>

  <!-- ç®¡ç†åƒè³½è€…æ¨¡æ…‹æ¡† -->
  <div id="manageUsersModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 16px; padding: 32px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2>ğŸ‘¥ ç®¡ç†åƒè³½è€…</h2>
        <button onclick="hideManageUsersModal()" style="background: #64748b; padding: 8px 16px;">âœ• é—œé–‰</button>
      </div>
      
      <!-- æª¢æŸ¥é»é…ç½® -->
      <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 12px;">
        <h3>ğŸš© æª¢æŸ¥é»é…ç½®</h3>
        <p style="margin-bottom: 16px;">è¨­ç½®æœ¬æ¬¡æ¯”è³½çš„æª¢æŸ¥é»ï¼ˆæœ€å°‘2å€‹ï¼Œæœ€å¤š10å€‹ï¼‰</p>
        
        <div style="margin-bottom: 16px;">
          <label>æª¢æŸ¥é»æ•¸é‡ï¼š</label>
          <input type="number" id="checkpointCount" min="2" max="10" value="2" style="width: 80px;">
          <button onclick="updateCheckpointFields()" style="background: #3b82f6;">æ›´æ–°æ•¸é‡</button>
        </div>
        
        <div id="checkpointFields">
          <!-- å‹•æ…‹ç”Ÿæˆæª¢æŸ¥é»é…ç½®å­—æ®µ -->
          <div class="checkpoint-field" style="display: flex; gap: 12px; margin-bottom: 8px;">
            <input placeholder="ä»£ç¢¼ï¼ˆå¦‚STARTï¼‰" style="width: 120px;" value="START">
            <input placeholder="åç¨±ï¼ˆå¦‚èµ·é»ï¼‰" style="flex: 1;" value="èµ·é»">
            <input type="number" placeholder="é †åº" style="width: 80px;" value="1">
            <label style="margin-top: 12px;">å¿…é: <input type="checkbox" checked></label>
          </div>
          <div class="checkpoint-field" style="display: flex; gap: 12px; margin-bottom: 8px;">
            <input placeholder="ä»£ç¢¼ï¼ˆå¦‚FINISHï¼‰" style="width: 120px;" value="FINISH">
            <input placeholder="åç¨±ï¼ˆå¦‚çµ‚é»ï¼‰" style="flex: 1;" value="çµ‚é»">
            <input type="number" placeholder="é †åº" style="width: 80px;" value="2">
            <label style="margin-top: 12px;">å¿…é: <input type="checkbox" checked></label>
          </div>
        </div>
        
        <button onclick="saveCheckpointConfigs()" style="background: #22c55e;">ä¿å­˜æª¢æŸ¥é»é…ç½®</button>
      </div>
      
      <!-- CSV å°å…¥åŠŸèƒ½ -->
      <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 12px;">
        <h3>ğŸ“ å¾ CSV å°å…¥åƒè³½è€…</h3>
        <p style="color: #64748b; margin-bottom: 16px;">CSV æ ¼å¼ï¼šè™Ÿç¢¼,å§“åï¼ˆä¾‹å¦‚ï¼š001,å¼µä¸‰ï¼‰</p>
        <input type="file" id="csvFileInput" accept=".csv" style="margin-bottom: 16px;">
        <button onclick="importFromCSV()" style="background: #22c55e;">ğŸ“¥ å°å…¥ CSV</button>
        <div id="csvImportStatus" style="margin-top: 16px; font-family: monospace;"></div>
      </div>
      
      <!-- æ‰‹å‹•æ·»åŠ åƒè³½è€… -->
      <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 12px;">
        <h3>â• æ‰‹å‹•æ·»åŠ åƒè³½è€…</h3>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          <input id="manualBibNumber" placeholder="è™Ÿç¢¼ï¼ˆå¦‚ï¼š001ï¼‰" style="width: 150px;">
          <input id="manualName" placeholder="å§“å" style="flex: 1;">
          <button onclick="addSingleUser()" style="background: #3b82f6;">â• æ·»åŠ </button>
        </div>
      </div>
      
      <!-- åƒè³½è€…åˆ—è¡¨ -->
      <div>
        <h3>ğŸ“‹ åƒè³½è€…åˆ—è¡¨</h3>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
          <table id="participantsTable" style="width: 100%; border-radius: 8px;">
            <thead>
              <tr>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; background: #f1f5f9;">è™Ÿç¢¼</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; background: #f1f5f9;">å§“å</th>
                <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0; background: #f1f5f9;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="participantsTableBody">
              <!-- åƒè³½è€…æ•¸æ“šå°‡å‹•æ…‹åŠ è¼‰ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let adminClient = null;
    let rankingMode = 'gun';
    let progressChart = null;
    let checkpoints = []; // å­˜å„²æª¢æŸ¥é»é…ç½®
    let allCheckins = []; // å­˜å„²æ‰€æœ‰æ‰“å¡è¨˜éŒ„

    // é é¢åŠ è¼‰æ™‚è‡ªå‹•é€£æ¥
    window.addEventListener('DOMContentLoaded', () => {
      // å˜—è©¦å¾æœ¬åœ°å­˜å„²ç²å–é€£æ¥ä¿¡æ¯
      const savedUrl = localStorage.getItem('nfc_admin_url');
      const savedKey = localStorage.getItem('nfc_admin_key');
      
      if (savedUrl && savedKey) {
        document.getElementById('adminUrl').value = savedUrl;
        document.getElementById('adminKey').value = savedKey;
        setTimeout(() => connectAdmin(), 1000); // å»¶é²1ç§’è‡ªå‹•é€£æ¥
      }
    });

    // é é¢åˆ‡æ›åŠŸèƒ½
    function showPage(pageId) {
      // éš±è—æ‰€æœ‰é é¢
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // é¡¯ç¤ºé¸ä¸­é é¢
      document.getElementById(`${pageId}-page`).classList.add('active');
      
      // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // åŠ è¼‰å°æ‡‰é é¢æ•¸æ“š
      if (pageId === 'ranking') {
        loadRankingData();
      } else if (pageId === 'checkins') {
        loadCheckinsData();
      } else {
        refreshData();
      }
    }

    // æª¢æŸ¥é»é…ç½®ç›¸é—œå‡½æ•¸
    function updateCheckpointFields() {
      const count = parseInt(document.getElementById('checkpointCount').value);
      const container = document.getElementById('checkpointFields');
      container.innerHTML = '';
      
      for (let i = 1; i <= count; i++) {
        const code = i === 1 ? 'START' : i === count ? 'FINISH' : `CP${i-1}`;
        const name = i === 1 ? 'èµ·é»' : i === count ? 'çµ‚é»' : `æª¢æŸ¥é»${i-1}`;
        
        const field = document.createElement('div');
        field.className = 'checkpoint-field';
        field.style = 'display: flex; gap: 12px; margin-bottom: 8px;';
        field.innerHTML = `
          <input placeholder="ä»£ç¢¼" style="width: 120px;" value="${code}">
          <input placeholder="åç¨±" style="flex: 1;" value="${name}">
          <input type="number" placeholder="é †åº" style="width: 80px;" value="${i}">
          <label style="margin-top: 12px;">å¿…é: <input type="checkbox" ${i === 1 || i === count ? 'checked' : ''}></label>
        `;
        container.appendChild(field);
      }
    }

    async function saveCheckpointConfigs() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£æ¥æ•¸æ“šåº«');
        return;
      }
      
      const fields = document.querySelectorAll('.checkpoint-field');
      const configs = Array.from(fields).map((field, index) => {
        const inputs = field.querySelectorAll('input');
        return {
          code: inputs[0].value,
          name: inputs[1].value,
          order_index: parseInt(inputs[2].value),
          is_required: inputs[3].checked,
          event_id: 'default' // é»˜èªç‚ºç•¶å‰è³½äº‹
        };
      });
      
      // å…ˆåˆªé™¤ç¾æœ‰é…ç½®
      const { error: deleteError } = await adminClient
        .from('checkpoint_configs')
        .delete()
        .eq('event_id', 'default');
      
      if (deleteError) {
        alert('åˆªé™¤èˆŠé…ç½®å¤±æ•—: ' + deleteError.message);
        return;
      }
      
      // ä¿å­˜æ–°é…ç½®
      const { error } = await adminClient
        .from('checkpoint_configs')
        .insert(configs);
      
      if (error) {
        alert('ä¿å­˜æª¢æŸ¥é»é…ç½®å¤±æ•—: ' + error.message);
      } else {
        alert('æª¢æŸ¥é»é…ç½®å·²ä¿å­˜');
        await loadCheckpoints(); // é‡æ–°åŠ è¼‰æª¢æŸ¥é»é…ç½®
        refreshData(); // åˆ·æ–°æ‰€æœ‰æ•¸æ“š
      }
    }

    // åŠ è¼‰æª¢æŸ¥é»é…ç½®
    async function loadCheckpoints() {
      if (!adminClient) return;
      
      const { data, error } = await adminClient
        .from('checkpoint_configs')
        .select('*')
        .eq('event_id', 'default')
        .order('order_index');
      
      if (error) {
        console.error('åŠ è¼‰æª¢æŸ¥é»é…ç½®å¤±æ•—:', error);
        // ä½¿ç”¨é»˜èªé…ç½®
        checkpoints = [
          { code: 'START', name: 'èµ·é»', order_index: 1, is_required: true },
          { code: 'FINISH', name: 'çµ‚é»', order_index: 2, is_required: true }
        ];
      } else {
        checkpoints = data.length > 0 ? data : [
          { code: 'START', name: 'èµ·é»', order_index: 1, is_required: true },
          { code: 'FINISH', name: 'çµ‚é»', order_index: 2, is_required: true }
        ];
      }
      
      // æ›´æ–°æª¢æŸ¥é»ç¯©é¸å™¨
      updateCheckpointFilters();
    }

    // æ›´æ–°æª¢æŸ¥é»ç¯©é¸å™¨é¸é …
    function updateCheckpointFilters() {
      const filters = [
        document.getElementById('checkpointFilter'),
        document.getElementById('rankingCheckpointFilter')
      ];
      
      filters.forEach(filter => {
        if (!filter) return;
        
        // ä¿å­˜ç•¶å‰é¸ä¸­å€¼
        const currentValue = filter.value;
        
        // æ¸…é™¤ç¾æœ‰é¸é …ï¼ˆä¿ç•™"æ‰€æœ‰æª¢æŸ¥é»"ï¼‰
        while (filter.options.length > 1) {
          filter.remove(1);
        }
        
        // æ·»åŠ æª¢æŸ¥é»é¸é …
        checkpoints.forEach(checkpoint => {
          const option = document.createElement('option');
          option.value = checkpoint.code;
          option.textContent = checkpoint.name;
          filter.appendChild(option);
        });
        
        // æ¢å¾©é¸ä¸­å€¼
        if (currentValue) {
          filter.value = currentValue;
        }
      });
    }

    // âœ… é€£ç·šå¾Œå°
    async function connectAdmin() {
      const url = document.getElementById('adminUrl').value.trim();
      const key = document.getElementById('adminKey').value.trim();
      const status = document.getElementById('status');

      try {
        if (!url || !key) {
          alert('URL æˆ– Key ç„¡å¡«');
          return;
        }

        // ä¿å­˜é€£æ¥ä¿¡æ¯åˆ°æœ¬åœ°å­˜å„²
        localStorage.setItem('nfc_admin_url', url);
        localStorage.setItem('nfc_admin_key', key);

        adminClient = window.supabase.createClient(url, key);

        status.textContent = 'é€£ç·šä¸­...';
        status.style.background = '#f59e0b';

        // æ¸¬è©¦é€£æ¥
        const { data, error } = await adminClient
          .from('participants')
          .select('*')
          .limit(1);

        if (error) {
          throw new Error('è®€å– participants å‡ºéŒ¯ï¼š' + error.message);
        }

        status.textContent = 'âœ… å¾Œå°å·²é€£ç·š';
        status.style.background = '#10b981';

        // é¡¯ç¤ºå°èˆªå’Œå„€è¡¨æ¿
        document.getElementById('navigation').style.display = 'block';
        document.getElementById('dashboard').style.display = 'grid';
        document.getElementById('progressChart').style.display = 'block';

        // åŠ è¼‰æª¢æŸ¥é»é…ç½®
        await loadCheckpoints();
        
        // é€£æ¥æˆåŠŸå¾Œï¼ŒåŠ è¼‰æ•¸æ“š
        await refreshData();

        // è¨­ç½®å¯¦æ™‚æ›´æ–°
        setupRealtimeUpdates();

      } catch (e) {
        console.error('é€£æ¥éŒ¯èª¤:', e);
        status.textContent = 'âŒ é€£ç·šå¤±æ•—';
        status.style.background = '#ef4444';
        alert('é€£ç·šå¤±æ•—ï¼š' + e.message);
      }
    }

    // è¨­ç½®å¯¦æ™‚æ›´æ–°
    function setupRealtimeUpdates() {
      if (!adminClient) return;
      
      // ç›£è½checkinsè¡¨çš„è®ŠåŒ–
      const checkinsSubscription = adminClient
        .channel('custom-filter-channel')
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'checkins' },
          (payload) => {
            logMessage(`ğŸ“¥ æ–°æ‰“å¡è¨˜éŒ„: ${payload.new.bib} åœ¨ ${payload.new.checkpoint_code}`);
            refreshData(); // æœ‰æ–°è¨˜éŒ„æ™‚åˆ·æ–°æ•¸æ“š
          }
        )
        .subscribe();
        
      logMessage('âœ… å·²é–‹å•Ÿå¯¦æ™‚æ›´æ–°');
    }

    // è¨­ç½®æ’åæ¨¡å¼
    function setMode(mode, event) {
      rankingMode = mode;
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      logMessage(`ğŸ”„ æ’åæ¨¡å¼å·²åˆ‡æ›ç‚º: ${
        mode === 'gun' ? 'çµ‚é»å…ˆå¾Œ' : 
        mode === 'chip' ? 'å¯¦éš›ç”¨æ™‚' : 'åˆ†æ®µæˆç¸¾'
      }`);
      
      // é‡æ–°åŠ è¼‰æ•¸æ“š
      refreshData();
    }

    // åˆ·æ–°æ‰€æœ‰æ•¸æ“š
    async function refreshData() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£ç·šåˆ°è³‡æ–™åº«');
        return;
      }
      
      try {
        logMessage('ğŸ”„ æ­£åœ¨åˆ·æ–°æ•¸æ“š...');
        
        // åŠ è¼‰åƒè³½è€…æ•¸æ“š
        await loadParticipants();
        
        // åŠ è¼‰æ‰“å¡è¨˜éŒ„
        await loadCheckinsData();
        
        // åŠ è¼‰ç¸½è¦½æ•¸æ“š
        await loadOverviewData();
        
        // åŠ è¼‰æ’åæ•¸æ“š
        await loadRankingData();
        
        // æ›´æ–°åœ–è¡¨
        updateProgressChart();
        
        logMessage('âœ… æ•¸æ“šåˆ·æ–°å®Œæˆ');
        
      } catch (e) {
        console.error('åˆ·æ–°æ•¸æ“šéŒ¯èª¤:', e);
        logMessage(`âŒ åˆ·æ–°æ•¸æ“šå¤±æ•—: ${e.message}`);
      }
    }

    // åŠ è¼‰ç¸½è¦½æ•¸æ“š
    async function loadOverviewData() {
      if (!adminClient) return;
      
      // 1. ç¸½åƒè³½äººæ•¸
      const { count: totalRunners } = await adminClient
        .from('participants')
        .select('*', { count: 'exact', head: true });
      
      // 2. å·²å‡ºç™¼äººæ•¸ï¼ˆæœ‰STARTæ‰“å¡è¨˜éŒ„ï¼‰
      const { count: startedRunners } = await adminClient
        .from('checkins')
        .select('DISTINCT(bib)', { count: 'exact', head: true })
        .eq('checkpoint_code', 'START');
      
      // 3. å·²å®Œè³½äººæ•¸ï¼ˆæœ‰FINISHæ‰“å¡è¨˜éŒ„ï¼‰
      const { count: finishedRunners } = await adminClient
        .from('checkins')
        .select('DISTINCT(bib)', { count: 'exact', head: true })
        .eq('checkpoint_code', 'FINISH');
      
      // 4. è¨ˆç®—å¹³å‡å®Œè³½æ™‚é–“
      let avgTime = '00:00';
      if (finishedRunners > 0) {
        // ç²å–æ‰€æœ‰å®Œè³½è€…çš„æˆç¸¾
        const { data: finishTimes } = await adminClient
          .from('checkins as finish')
          .select(`
            finish.bib, 
            finish.checkin_time,
            start.checkin_time as start_time
          `)
          .eq('finish.checkpoint_code', 'FINISH')
          .eq('start.checkpoint_code', 'START')
          .join('checkins as start', 'finish.bib', 'start.bib');
        
        if (finishTimes && finishTimes.length > 0) {
          // è¨ˆç®—ç¸½ç”¨æ™‚ï¼ˆæ¯«ç§’ï¼‰
          let totalMs = 0;
          finishTimes.forEach(record => {
            const finish = new Date(record.checkin_time).getTime();
            const start = new Date(record.start_time).getTime();
            totalMs += (finish - start);
          });
          
          // è¨ˆç®—å¹³å‡ç”¨æ™‚
          const avgMs = totalMs / finishTimes.length;
          avgTime = formatDuration(avgMs);
        }
      }
      
      // æ›´æ–°UI
      document.getElementById('totalRunners').textContent = totalRunners || 0;
      document.getElementById('startedRunners').textContent = startedRunners || 0;
      document.getElementById('finishedRunners').textContent = finishedRunners || 0;
      document.getElementById('avgTime').textContent = avgTime;
      
      // æ›´æ–°ç¸½è¦½è¡¨æ ¼
      updateResultsTable();
    }

    // æ›´æ–°ç¸½è¦½é é¢è¡¨æ ¼
    async function updateResultsTable() {
      if (!adminClient) return;
      
      // ç²å–æ‰€æœ‰æœ‰èµ·é»å’Œçµ‚é»è¨˜éŒ„çš„é¸æ‰‹
      const { data } = await adminClient
        .from('checkins as finish')
        .select(`
          finish.bib,
          participants.name,
          finish.checkin_time as finish_time,
          start.checkin_time as start_time
        `)
        .eq('finish.checkpoint_code', 'FINISH')
        .eq('start.checkpoint_code', 'START')
        .join('checkins as start', 'finish.bib', 'start.bib')
        .join('participants', 'finish.bib', 'participants.bib');
      
      if (!data || data.length === 0) {
        document.getElementById('resultsTable').querySelector('tbody').innerHTML = 
          '<tr><td colspan="6" style="text-align: center; padding: 20px;">æš‚æ— å®Œè³½è¨˜éŒ„</td></tr>';
        return;
      }
      
      // è¨ˆç®—æ¯å€‹é¸æ‰‹çš„ç”¨æ™‚
      const runners = data.map(record => {
        const startTime = new Date(record.start_time);
        const finishTime = new Date(record.finish_time);
        const durationMs = finishTime - startTime;
        
        return {
          bib: record.bib,
          name: record.name,
          start: formatDateTime(startTime),
          finish: formatDateTime(finishTime),
          duration: formatDuration(durationMs),
          durationMs: durationMs,
          finishTime: finishTime.getTime()
        };
      });
      
      // æ ¹æ“šæ’åæ¨¡å¼æ’åº
      let sortedRunners = [...runners];
      if (rankingMode === 'gun') {
        // æŒ‰çµ‚é»æ™‚é–“æ’åºï¼ˆå…ˆåˆ°å…ˆå¾—ï¼‰
        sortedRunners.sort((a, b) => a.finishTime - b.finishTime);
      } else {
        // æŒ‰å¯¦éš›ç”¨æ™‚æ’åºï¼ˆçŸ­è€…å„ªå…ˆï¼‰
        sortedRunners.sort((a, b) => a.durationMs - b.durationMs);
      }
      
      // æ›´æ–°è¡¨æ ¼
      const tbody = document.getElementById('resultsTable').querySelector('tbody');
      tbody.innerHTML = '';
      
      sortedRunners.forEach((runner, index) => {
        const row = document.createElement('tr');
        // å‰ä¸‰åæ·»åŠ ç‰¹æ®Šæ¨£å¼
        if (index === 0) row.className = 'gold';
        if (index === 1) row.className = 'silver';
        if (index === 2) row.className = 'bronze';
        
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${runner.bib}</td>
          <td>${runner.name}</td>
          <td>${runner.start}</td>
          <td>${runner.finish}</td>
          <td>${runner.duration}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // åŠ è¼‰æ’åè©³æƒ…æ•¸æ“š
    async function loadRankingData() {
      if (!adminClient) return;
      
      const checkpointFilter = document.getElementById('rankingCheckpointFilter').value;
      
      // ç²å–æ‰€æœ‰åƒè³½è€…
      const { data: participants } = await adminClient
        .from('participants')
        .select('*');
      
      if (!participants || participants.length === 0) {
        document.getElementById('detailedRankingTable').querySelector('tbody').innerHTML = 
          '<tr><td colspan="5" style="text-align: center; padding: 20px;">æš‚æ— åƒè³½è€…æ•¸æ“š</td></tr>';
        return;
      }
      
      // ç²å–æ‰€æœ‰æ‰“å¡è¨˜éŒ„
      let checkpointWhere = '';
      if (checkpointFilter !== 'all') {
        checkpointWhere = `.eq('checkpoint_code', '${checkpointFilter}')`;
      }
      
      const { data: checkins } = await adminClient
        .from('checkins')
        .select('*')
        .order('checkin_time');
      
      // æ•´ç†æ¯å€‹é¸æ‰‹çš„æ‰“å¡è¨˜éŒ„
      const runnerData = {};
      
      participants.forEach(participant => {
        runnerData[participant.bib] = {
          bib: participant.bib,
          name: participant.name,
          checkins: {},
          totalTimeMs: null
        };
      });
      
      checkins.forEach(checkin => {
        if (runnerData[checkin.bib]) {
          runnerData[checkin.bib].checkins[checkin.checkpoint_code] = {
            time: new Date(checkin.checkin_time),
            timeStr: formatDateTime(new Date(checkin.checkin_time))
          };
        }
      });
      
      // è¨ˆç®—ç¸½ç”¨æ™‚ï¼ˆåŸºæ–¼èµ·é»å’Œçµ‚é»ï¼‰
      Object.values(runnerData).forEach(runner => {
        const start = runner.checkins['START'];
        const finish = runner.checkins['FINISH'];
        
        if (start && finish) {
          runner.totalTimeMs = finish.time - start.time;
          runner.totalTimeStr = formatDuration(runner.totalTimeMs);
        } else {
          runner.totalTimeStr = 'æœªå®Œæˆ';
        }
      });
      
      // è½‰æ›ç‚ºæ•¸çµ„ä¸¦æ’åº
      let runners = Object.values(runnerData);
      
      // æ ¹æ“šæ’åæ¨¡å¼å’Œç¯©é¸æ¢ä»¶æ’åº
      if (rankingMode === 'gun' && checkpointFilter === 'all') {
        // æŒ‰çµ‚é»æ™‚é–“æ’åº
        runners.sort((a, b) => {
          if (!a.checkins['FINISH']) return 1;
          if (!b.checkins['FINISH']) return -1;
          return a.checkins['FINISH'].time - b.checkins['FINISH'].time;
        });
      } else if (rankingMode === 'chip' && checkpointFilter === 'all') {
        // æŒ‰ç¸½ç”¨æ™‚æ’åº
        runners.sort((a, b) => {
          if (a.totalTimeMs === null) return 1;
          if (b.totalTimeMs === null) return -1;
          return a.totalTimeMs - b.totalTimeMs;
        });
      } else if (checkpointFilter !== 'all') {
        // æŒ‰ç‰¹å®šæª¢æŸ¥é»æ™‚é–“æ’åº
        runners.sort((a, b) => {
          if (!a.checkins[checkpointFilter]) return 1;
          if (!b.checkins[checkpointFilter]) return -1;
          return a.checkins[checkpointFilter].time - b.checkins[checkpointFilter].time;
        });
      }
      
      // æ›´æ–°æ’åè¡¨æ ¼
      const tbody = document.getElementById('detailedRankingTable').querySelector('tbody');
      tbody.innerHTML = '';
      
      runners.forEach((runner, index) => {
        // åªé¡¯ç¤ºæœ‰è‡³å°‘ä¸€å€‹æ‰“å¡è¨˜éŒ„çš„é¸æ‰‹
        if (Object.keys(runner.checkins).length === 0) return;
        
        const row = document.createElement('tr');
        // å‰ä¸‰åæ·»åŠ ç‰¹æ®Šæ¨£å¼
        if (index === 0) row.className = 'gold';
        if (index === 1) row.className = 'silver';
        if (index === 2) row.className = 'bronze';
        
        // æ§‹å»ºæª¢æŸ¥é»æ™‚é–“å­—ç¬¦ä¸²
        let checkpointsHtml = '';
        checkpoints.forEach(cp => {
          const checkin = runner.checkins[cp.code];
          checkpointsHtml += `
            <div><strong>${cp.name}:</strong> ${checkin ? checkin.timeStr : 'æœªæ‰“å¡'}</div>
          `;
        });
        
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${runner.bib}</td>
          <td>${runner.name}</td>
          <td>${checkpointsHtml}</td>
          <td>${runner.totalTimeStr}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // åŠ è¼‰æ‰“å¡è¨˜éŒ„æ•¸æ“š
    async function loadCheckinsData() {
      if (!adminClient) return;
      
      // ç²å–æ‰€æœ‰æ‰“å¡è¨˜éŒ„ï¼ˆåŒ…å«åƒè³½è€…å§“åï¼‰
      const { data } = await adminClient
        .from('checkins')
        .select(`
          *,
          participants(name)
        `)
        .order('checkin_time', { ascending: false })
        .limit(1000);
      
      if (!data || data.length === 0) {
        document.getElementById('checkinsTable').querySelector('tbody').innerHTML = 
          '<tr><td colspan="4" style="text-align: center; padding: 20px;">æš‚æ— æ‰“å¡è¨˜éŒ„</td></tr>';
        allCheckins = [];
        return;
      }
      
      // ä¿å­˜æ‰€æœ‰æ‰“å¡è¨˜éŒ„ç”¨æ–¼ç¯©é¸
      allCheckins = data;
      
      // æ‡‰ç”¨ç•¶å‰ç¯©é¸æ¢ä»¶
      filterCheckins();
    }

    // ç¯©é¸æ‰“å¡è¨˜éŒ„
    function filterCheckins() {
      const checkpointFilter = document.getElementById('checkpointFilter').value;
      const bibFilter = document.getElementById('bibFilter').value.trim().toLowerCase();
      
      // æ‡‰ç”¨ç¯©é¸
      let filtered = allCheckins;
      
      if (checkpointFilter !== 'all') {
        filtered = filtered.filter(checkin => checkin.checkpoint_code === checkpointFilter);
      }
      
      if (bibFilter) {
        filtered = filtered.filter(checkin => 
          checkin.bib.toLowerCase().includes(bibFilter) ||
          (checkin.participants && checkin.participants.name.toLowerCase().includes(bibFilter))
        );
      }
      
      // æ›´æ–°è¡¨æ ¼
      const tbody = document.getElementById('checkinsTable').querySelector('tbody');
      tbody.innerHTML = '';
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</td></tr>';
        return;
      }
      
      filtered.forEach(checkin => {
        const row = document.createElement('tr');
        const checkpoint = checkpoints.find(cp => cp.code === checkin.checkpoint_code) || { name: checkin.checkpoint_code };
        
        row.innerHTML = `
          <td>${formatDateTime(new Date(checkin.checkin_time))}</td>
          <td>${checkin.bib}</td>
          <td>${checkin.participants ? checkin.participants.name : 'æœªçŸ¥'}</td>
          <td>${checkpoint.name}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // åŠ è¼‰åƒè³½è€…æ•¸æ“š
    async function loadParticipants() {
      if (!adminClient) return;
      
      const { data } = await adminClient
        .from('participants')
        .select('*')
        .order('bib');
      
      const tbody = document.getElementById('participantsTableBody');
      tbody.innerHTML = '';
      
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">æš‚æ— åƒè³½è€…</td></tr>';
        return;
      }
      
      data.forEach(participant => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${participant.bib}</td>
          <td>${participant.name}</td>
          <td style="text-align: center;">
            <button onclick="editParticipant('${participant.bib}', '${participant.name}')" style="padding: 4px 8px; background: #3b82f6; margin-right: 4px;">ç·¨è¼¯</button>
            <button onclick="deleteParticipant('${participant.bib}')" style="padding: 4px 8px; background: #ef4444;">åˆªé™¤</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // æ·»åŠ å–®å€‹åƒè³½è€…
    async function addSingleUser() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£æ¥æ•¸æ“šåº«');
        return;
      }
      
      const bib = document.getElementById('manualBibNumber').value.trim();
      const name = document.getElementById('manualName').value.trim();
      
      if (!bib || !name) {
        alert('è«‹å¡«å¯«è™Ÿç¢¼å’Œå§“å');
        return;
      }
      
      try {
        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const { data: existing } = await adminClient
          .from('participants')
          .select('*')
          .eq('bib', bib)
          .single();
          
        if (existing) {
          alert(`è™Ÿç¢¼ ${bib} å·²å­˜åœ¨`);
          return;
        }
        
        // æ·»åŠ æ–°åƒè³½è€…
        const { error } = await adminClient
          .from('participants')
          .insert([{ bib, name }]);
          
        if (error) throw error;
        
        logMessage(`âœ… å·²æ·»åŠ åƒè³½è€…: ${bib} - ${name}`);
        
        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('manualBibNumber').value = '';
        document.getElementById('manualName').value = '';
        
        // åˆ·æ–°åƒè³½è€…åˆ—è¡¨
        loadParticipants();
        
      } catch (e) {
        console.error('æ·»åŠ åƒè³½è€…éŒ¯èª¤:', e);
        alert('æ·»åŠ å¤±æ•—: ' + e.message);
      }
    }

    // ç·¨è¼¯åƒè³½è€…
    async function editParticipant(bib, currentName) {
      if (!adminClient) return;
      
      const newName = prompt(`ç·¨è¼¯è™Ÿç¢¼ ${bib} çš„åƒè³½è€…å§“å`, currentName);
      if (newName === null) return; // ç”¨æˆ¶å–æ¶ˆ
      if (newName.trim() === '') {
        alert('å§“åä¸èƒ½ç‚ºç©º');
        return;
      }
      
      try {
        const { error } = await adminClient
          .from('participants')
          .update({ name: newName })
          .eq('bib', bib);
          
        if (error) throw error;
        
        logMessage(`âœ… å·²æ›´æ–°åƒè³½è€…: ${bib} - ${newName}`);
        loadParticipants();
        
      } catch (e) {
        console.error('æ›´æ–°åƒè³½è€…éŒ¯èª¤:', e);
        alert('æ›´æ–°å¤±æ•—: ' + e.message);
      }
    }

    // åˆªé™¤åƒè³½è€…
    async function deleteParticipant(bib) {
      if (!adminClient) return;
      
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤è™Ÿç¢¼ ${bib} çš„åƒè³½è€…å—ï¼Ÿ\nç›¸é—œçš„æ‰“å¡è¨˜éŒ„ä¹Ÿæœƒè¢«åˆªé™¤`)) {
        return;
      }
      
      try {
        // åˆªé™¤åƒè³½è€…ï¼ˆæœƒè‡ªå‹•åˆªé™¤ç›¸é—œæ‰“å¡è¨˜éŒ„ï¼Œå› ç‚ºæœ‰ON DELETE CASCADEï¼‰
        const { error } = await adminClient
          .from('participants')
          .delete()
          .eq('bib', bib);
          
        if (error) throw error;
        
        logMessage(`âœ… å·²åˆªé™¤åƒè³½è€…: ${bib}`);
        loadParticipants();
        refreshData(); // åˆ·æ–°æ‰€æœ‰æ•¸æ“š
        
      } catch (e) {
        console.error('åˆªé™¤åƒè³½è€…éŒ¯èª¤:', e);
        alert('åˆªé™¤å¤±æ•—: ' + e.message);
      }
    }

    // å¾CSVå°å…¥åƒè³½è€…
    async function importFromCSV() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£æ¥æ•¸æ“šåº«');
        return;
      }
      
      const fileInput = document.getElementById('csvFileInput');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('è«‹é¸æ“‡CSVæ–‡ä»¶');
        return;
      }
      
      const file = fileInput.files[0];
      const statusElement = document.getElementById('csvImportStatus');
      statusElement.textContent = 'æ­£åœ¨è§£ææ–‡ä»¶...';
      
      try {
        // è®€å–æ–‡ä»¶å…§å®¹
        const text = await readFileAsync(file);
        const lines = text.split('\n');
        
        // æº–å‚™è¦å°å…¥çš„æ•¸æ“š
        const participants = [];
        let errors = [];
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const [bib, name] = line.split(',').map(item => item.trim());
          
          if (!bib || !name) {
            errors.push(`ç¬¬ ${i+1} è¡Œæ ¼å¼éŒ¯èª¤: ${line}`);
            continue;
          }
          
          participants.push({ bib, name });
        }
        
        if (errors.length > 0) {
          statusElement.style.color = '#ef4444';
          statusElement.textContent = `è§£æéŒ¯èª¤:\n${errors.join('\n')}\n\nå°‡è·³ééŒ¯èª¤è¡Œç¹¼çºŒå°å…¥`;
        }
        
        if (participants.length === 0) {
          alert('æ²’æœ‰å¯å°å…¥çš„æœ‰æ•ˆæ•¸æ“š');
          return;
        }
        
        // æ‰¹é‡å°å…¥
        statusElement.style.color = '#f59e0b';
        statusElement.textContent = `æ­£åœ¨å°å…¥ ${participants.length} ååƒè³½è€…...`;
        
        // åˆ†æ‰¹å°å…¥ï¼ˆé¿å…è«‹æ±‚éå¤§ï¼‰
        const batchSize = 100;
        let successCount = 0;
        let duplicateCount = 0;
        
        for (let i = 0; i < participants.length; i += batchSize) {
          const batch = participants.slice(i, i + batchSize);
          
          const { error } = await adminClient
            .from('participants')
            .insert(batch)
            .onConflict('bib') // é‡åˆ°é‡è¤‡è™Ÿç¢¼æ™‚è·³é
            .ignore();
          
          if (error) throw error;
          
          successCount += batch.length;
          statusElement.textContent = `å·²å°å…¥ ${successCount}/${participants.length} ååƒè³½è€…...`;
        }
        
        // çµ±è¨ˆå¯¦éš›æˆåŠŸå°å…¥çš„æ•¸é‡ï¼ˆæ’é™¤é‡è¤‡ï¼‰
        const { count: totalAfter } = await adminClient
          .from('participants')
          .select('*', { count: 'exact', head: true });
          
        const { count: totalBefore } = await adminClient
          .from('participants')
          .select('*', { count: 'exact', head: true })
          .lt('created_at', new Date().toISOString());
          
        const actualSuccess = totalAfter - totalBefore;
        duplicateCount = participants.length - actualSuccess;
        
        statusElement.style.color = '#10b981';
        statusElement.textContent = `å°å…¥å®Œæˆï¼\næˆåŠŸå°å…¥: ${actualSuccess} å\nå·²å­˜åœ¨ï¼ˆè·³éï¼‰: ${duplicateCount} å`;
        
        // åˆ·æ–°åƒè³½è€…åˆ—è¡¨
        loadParticipants();
        
        // é‡ç½®æ–‡ä»¶è¼¸å…¥
        fileInput.value = '';
        
      } catch (e) {
        console.error('CSVå°å…¥éŒ¯èª¤:', e);
        statusElement.style.color = '#ef4444';
        statusElement.textContent = `å°å…¥å¤±æ•—: ${e.message}`;
      }
    }

    // é¡¯ç¤ºç®¡ç†åƒè³½è€…æ¨¡æ…‹æ¡†
    function showManageUsersModal() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£æ¥æ•¸æ“šåº«');
        return;
      }
      
      // åŠ è¼‰åƒè³½è€…æ•¸æ“š
      loadParticipants();
      
      // é¡¯ç¤ºæ¨¡æ…‹æ¡†
      document.getElementById('manageUsersModal').style.display = 'flex';
    }

    // éš±è—ç®¡ç†åƒè³½è€…æ¨¡æ…‹æ¡†
    function hideManageUsersModal() {
      document.getElementById('manageUsersModal').style.display = 'none';
    }

    // æ¸…ç©ºæ‰€æœ‰æ•¸æ“š
    async function clearAllData() {
      if (!adminClient) return;
      
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿ\næ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰åƒè³½è€…å’Œæ‰“å¡è¨˜éŒ„ï¼Œç„¡æ³•æ¢å¾©ï¼')) {
        return;
      }
      
      try {
        logMessage('ğŸ—‘ï¸ æ­£åœ¨æ¸…ç©ºæ‰€æœ‰æ•¸æ“š...');
        
        // å…ˆåˆªé™¤æ‰“å¡è¨˜éŒ„
        const { error: checkinsError } = await adminClient
          .from('checkins')
          .delete()
          .neq('id', 0); // åˆªé™¤æ‰€æœ‰è¨˜éŒ„
          
        if (checkinsError) throw checkinsError;
        
        // å†åˆªé™¤åƒè³½è€…
        const { error: participantsError } = await adminClient
          .from('participants')
          .delete()
          .neq('id', 0); // åˆªé™¤æ‰€æœ‰è¨˜éŒ„
          
        if (participantsError) throw participantsError;
        
        logMessage('âœ… æ‰€æœ‰æ•¸æ“šå·²æ¸…ç©º');
        refreshData();
        
      } catch (e) {
        console.error('æ¸…ç©ºæ•¸æ“šéŒ¯èª¤:', e);
        logMessage(`âŒ æ¸…ç©ºæ•¸æ“šå¤±æ•—: ${e.message}`);
        alert('æ¸…ç©ºå¤±æ•—: ' + e.message);
      }
    }

    // åŒ¯å‡ºCSV
    async function exportCSV() {
      if (!adminClient) {
        alert('è«‹å…ˆé€£æ¥æ•¸æ“šåº«');
        return;
      }
      
      try {
        logMessage('ğŸ’¾ æ­£åœ¨æº–å‚™CSVæ•¸æ“š...');
        
        // 1. ç²å–æ‰€æœ‰åƒè³½è€…
        const { data: participants } = await adminClient
          .from('participants')
          .select('*');
          
        if (!participants || participants.length === 0) {
          alert('æ²’æœ‰åƒè³½è€…æ•¸æ“šå¯åŒ¯å‡º');
          return;
        }
        
        // 2. ç²å–æ‰€æœ‰æ‰“å¡è¨˜éŒ„
        const { data: checkins } = await adminClient
          .from('checkins')
          .select('*');
          
        // 3. æ•´ç†æ•¸æ“š
        let csvContent = 'è™Ÿç¢¼,å§“å';
        
        // æ·»åŠ æª¢æŸ¥é»æ¨™é¡Œ
        checkpoints.forEach(checkpoint => {
          csvContent += `,${checkpoint.name}æ™‚é–“`;
        });
        
        // å¦‚æœæœ‰èµ·é»å’Œçµ‚é»ï¼Œæ·»åŠ ç¸½ç”¨æ™‚
        const hasStartAndFinish = checkpoints.some(cp => cp.code === 'START') && 
                                 checkpoints.some(cp => cp.code === 'FINISH');
                                 
        if (hasStartAndFinish) {
          csvContent += ',ç¸½ç”¨æ™‚(HH:MM:SS)';
        }
        
        csvContent += '\n';
        
        // æ·»åŠ æ¯å€‹åƒè³½è€…çš„æ•¸æ“š
        participants.forEach(participant => {
          let row = `${participant.bib},${participant.name}`;
          
          // æ”¶é›†è©²åƒè³½è€…çš„æ‰€æœ‰æ‰“å¡è¨˜éŒ„
          const runnerCheckins = checkins.filter(c => c.bib === participant.bib);
          const checkinMap = {};
          
          runnerCheckins.forEach(checkin => {
            checkinMap[checkin.checkpoint_code] = new Date(checkin.checkin_time);
          });
          
          // æ·»åŠ æ¯å€‹æª¢æŸ¥é»çš„æ™‚é–“
          let startTime = null;
          let finishTime = null;
          
          checkpoints.forEach(checkpoint => {
            const checkinTime = checkinMap[checkpoint.code];
            row += ',' + (checkinTime ? formatDateTime(checkinTime) : '');
            
            if (checkpoint.code === 'START') startTime = checkinTime;
            if (checkpoint.code === 'FINISH') finishTime = checkinTime;
          });
          
          // æ·»åŠ ç¸½ç”¨æ™‚
          if (hasStartAndFinish && startTime && finishTime) {
            const durationMs = finishTime - startTime;
            row += ',' + formatDuration(durationMs);
          } else if (hasStartAndFinish) {
            row += ',';
          }
          
          csvContent += row + '\n';
        });
        
        // 4. å‰µå»ºä¸¦ä¸‹è¼‰CSVæ–‡ä»¶
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `race_results_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        logMessage('âœ… CSVæ–‡ä»¶å·²ä¸‹è¼‰');
        
      } catch (e) {
        console.error('åŒ¯å‡ºCSVéŒ¯èª¤:', e);
        logMessage(`âŒ åŒ¯å‡ºCSVå¤±æ•—: ${e.message}`);
        alert('åŒ¯å‡ºå¤±æ•—: ' + e.message);
      }
    }

    // æ›´æ–°é€²åº¦åœ–è¡¨
    function updateProgressChart() {
      const ctx = document.getElementById('progressChartCanvas').getContext('2d');
      const total = parseInt(document.getElementById('totalRunners').textContent) || 0;
      const finished = parseInt(document.getElementById('finishedRunners').textContent) || 0;
      const started = parseInt(document.getElementById('startedRunners').textContent) || 0;
      const notStarted = total - started;
      
      // éŠ·æ¯€ç¾æœ‰åœ–è¡¨
      if (progressChart) {
        progressChart.destroy();
      }
      
      // å‰µå»ºæ–°åœ–è¡¨
      progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['å·²å®Œè³½', 'é€²è¡Œä¸­', 'æœªé–‹å§‹'],
          datasets: [{
            data: [finished, started - finished, notStarted],
            backgroundColor: ['#10b981', '#3b82f6', '#94a3b8'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            },
            title: {
              display: true,
              text: `ç¸½åƒè³½äººæ•¸: ${total}`
            }
          }
        }
      });
    }

    // è¨˜éŒ„æ—¥èªŒ
    function logMessage(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      // æ·»åŠ é¡è‰²æ¨£å¼
      if (message.includes('âœ…')) logEntry.style.color = '#10b981';
      else if (message.includes('âŒ')) logEntry.style.color = '#ef4444';
      else if (message.includes('âš ï¸')) logEntry.style.color = '#f59e0b';
      else if (message.includes('ğŸ”„') || message.includes('ğŸ“¥')) logEntry.style.color = '#3b82f6';
      
      logElement.appendChild(logEntry);
      logElement.scrollTop = logElement.scrollHeight; // æ»¾å‹•åˆ°åº•éƒ¨
    }

    // å·¥å…·å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
    function formatDateTime(date) {
      return date.toLocaleString('zh-HK', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // å·¥å…·å‡½æ•¸ï¼šæ ¼å¼åŒ–æ™‚é–“é•·åº¦ï¼ˆæ¯«ç§’ -> HH:MM:SSï¼‰
    function formatDuration(ms) {
      if (ms < 0) return '00:00:00';
      
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      return [
        hours.toString().padStart(2, '0'),
        minutes.toString().padStart(2, '0'),
        seconds.toString().padStart(2, '0')
      ].join(':');
    }

    // å·¥å…·å‡½æ•¸ï¼šç•°æ­¥è®€å–æ–‡ä»¶
    function readFileAsync(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }
  </script>
</body>
</html>
