<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>ğŸ NFC è·‘æ‰‹æ‰“å¡æ©Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #ffffff; 
      color: #000000; 
      min-height: 100vh; display: flex; flex-direction: column; 
      align-items: center; justify-content: center; padding: 20px; text-align: center;
    }
    .card { background: rgba(255,255,255,0.95); border-radius: 24px; padding: 40px; max-width: 400px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    input { width: 100%; padding: 16px; margin: 12px 0; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
    button { width: 100%; padding: 20px; margin: 12px 0; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .checkpoint-btn { background: #3b82f6; color: white; }
    .start { background: #10b981; color: white; }
    .finish { background: #ef4444; color: white; }
    button:active { transform: scale(0.98); }
    #log { background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 14px; color: #1e293b; }
    .connected { background: #10b981 !important; }
    .status { padding: 12px; border-radius: 12px; margin: 12px 0; font-weight: bold; }
    .mode-selector { margin: 20px 0; }
    .mode-btn { padding: 8px 16px; margin: 0 4px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
    .mode-btn.active { background: #3b82f6; color: white; }
    .last-bib { margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; color: #1e293b; font-weight: bold; }
    .checkpoint-selector { margin: 20px 0; }
    .checkpoint-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸƒâ€â™‚ï¸ NFC è¨ˆæ™‚ç«™</h1>
    
    <div id="connectionSection" style="display: none;">
      <input id="url" placeholder="https://wceywyxwyygbwfodjdpp.supabase.co" value="https://vzulldiiuguzobjcpikh.supabase.co">
      <input id="key" placeholder="sb_publishable_BWBxXzGk8bRGql3VbkCqbA_IZOfH5rc" type="password" value="sb_publishable_SBltOg1AOREur1bYWij2kg_BneOwzh4">
      <button onclick="connect()">ğŸ”— é€£ç·šè³‡æ–™åº«</button>
      <button onclick="testConnection()" style="background: #6366f1; margin-top: 8px;">ğŸ” æ¸¬è©¦é€£ç·š</button>
    </div>
    <button onclick="toggleConnectionSection()" style="background: #6b7280; margin-bottom: 12px;">âš™ï¸ è¨­ç½®</button>
    
    <div id="status" class="status" style="background: #f59e0b;">æœªé€£ç·š</div>
    
    <div class="mode-selector">
      <button class="mode-btn active" onclick="setMode('manual', event)">æ‰‹å‹•è¼¸å…¥</button>
      <button class="mode-btn" onclick="enableNfcMode(event)">NFCæ¨¡å¼</button>
    </div>
    
    <div class="checkpoint-selector">
      <h3>é¸æ“‡æª¢æŸ¥é»</h3>
      <div id="checkpointGrid" class="checkpoint-grid">
        <button class="checkpoint-btn start" onclick="selectCheckpoint('START')">ğŸš€ èµ·é»</button>
        <button class="checkpoint-btn finish" onclick="selectCheckpoint('FINISH')">ğŸ çµ‚é»</button>
      </div>
      <div style="margin: 10px 0; font-weight: bold;">ç•¶å‰: <span id="currentCheckpoint">æœªé¸æ“‡</span></div>
    </div>
    
    <input type="text" id="bibInput" placeholder="è¼¸å…¥è™Ÿç¢¼å¸ƒç·¨è™Ÿ" style="margin: 15px 0;">
    <button id="punchBtn" onclick="punchCurrentCheckpoint()" disabled>ğŸ“Œ æ‰“å¡</button>
    
    <div class="last-bib">
      ä¸Šæ¬¡æ‰“å¡è™Ÿç¢¼: <span id="lastBib">-</span>
    </div>
    
    <div id="log">å³æ™‚è¨˜éŒ„æœƒé¡¯ç¤ºåœ¨æ­¤...</div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let client = null;
    let currentMode = 'manual';
    let lastBibNumber = '';
    let nfcReader = null;
    let currentCheckpoint = null;
    let checkpoints = [
      { code: 'START', name: 'èµ·é»', color: '#10b981' },
      { code: 'FINISH', name: 'çµ‚é»', color: '#ef4444' }
    ];
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
    window.addEventListener('DOMContentLoaded', () => {
      // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–è¿æ¥ä¿¡æ¯
      const savedUrl = localStorage.getItem('nfc_checkpoint_url');
      const savedKey = localStorage.getItem('nfc_checkpoint_key');
      const savedMode = localStorage.getItem('nfc_checkpoint_mode');
      const savedLastBib = localStorage.getItem('nfc_last_bib');
      
      // è®¾ç½®é»˜è®¤è¿æ¥ä¿¡æ¯ï¼ˆå¦‚æœæœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ï¼‰
      const defaultUrl = 'https://wceywyxwyygbwfodjdpp.supabase.co';
      const defaultKey = 'sb_publishable_BWBxXzGk8bRGql3VbkCqbA_IZOfH5rc';
      
      if (savedUrl && savedKey) {
        document.getElementById('url').value = savedUrl;
        document.getElementById('key').value = savedKey;
      } else {
        // ä½¿ç”¨é»˜è®¤è¿æ¥ä¿¡æ¯
        document.getElementById('url').value = defaultUrl;
        document.getElementById('key').value = defaultKey;
        // ä¿å­˜é»˜è®¤è¿æ¥ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('nfc_checkpoint_url', defaultUrl);
        localStorage.setItem('nfc_checkpoint_key', defaultKey);
      }
      
      // ç«‹å³è‡ªåŠ¨è¿æ¥æ•°æ®åº“
      setTimeout(() => connect(), 500); // å»¶è¿Ÿ0.5ç§’è‡ªåŠ¨è¿æ¥
      
      if (savedMode) {
        setMode(savedMode);
      }
      
      if (savedLastBib) {
        lastBibNumber = savedLastBib;
        document.getElementById('lastBib').textContent = savedLastBib;
      }
    });
    
    // åˆ‡æ¢è¿æ¥è®¾ç½®åŒºåŸŸçš„æ˜¾ç¤º/éšè—
    function toggleConnectionSection() {
      const section = document.getElementById('connectionSection');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        logMessage('âš™ï¸ é¡¯ç¤ºé€£ç·šè¨­ç½®');
      } else {
        section.style.display = 'none';
        logMessage('âš™ï¸ éš±è—é€£ç·šè¨­ç½®');
      }
    }
    
    // æµ‹è¯•è¿æ¥å‡½æ•°
    async function testConnection() {
      console.log('=== æµ‹è¯•è¿æ¥å‡½æ•°è¢«è°ƒç”¨ ===');
      
      try {
        const url = document.getElementById('url').value.trim();
        const key = document.getElementById('key').value.trim();
        
        console.log('URL:', url);
        console.log('Key length:', key ? key.length : 0);
        
        if (!url || !key) {
          const msg = 'âŒ è«‹å¡«å¯«URLå’ŒKey';
          console.log(msg);
          alert(msg);
          return;
        }
        
        // æ˜¾ç¤ºæµ‹è¯•çŠ¶æ€
        logMessage('ğŸ” é–‹å§‹æ¸¬è©¦é€£ç·š...');
        
        // æ£€æŸ¥æµè§ˆå™¨ç¯å¢ƒ
        console.log('æµè§ˆå™¨ä¿¡æ¯:', navigator.userAgent);
        console.log('æ˜¯å¦HTTPS:', window.location.protocol === 'https:');
        
        // æ£€æŸ¥Supabase SDK
        console.log('window.supabase:', window.supabase);
        if (!window.supabase) {
          throw new Error('âŒ Supabase SDKæœªåŠ è¼‰ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ–CDNéˆæ¥');
        }
        
        logMessage('âœ… Supabase SDKå·²åŠ è¼‰');
        
        try {
          // åˆ›å»ºä¸´æ—¶å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥
          console.log('å‰µå»ºSupabaseå®¢æˆ¶ç«¯...');
          const testClient = window.supabase.createClient(url, key);
          console.log('Supabaseå®¢æˆ¶ç«¯å‰µå»ºæˆåŠŸ:', testClient);
          logMessage('âœ… æˆåŠŸå‰µå»ºSupabaseå®¢æˆ¶ç«¯');
          
          // æµ‹è¯•æ•°æ®åº“è¿æ¥
          logMessage('ğŸ” æ¸¬è©¦æ•¸æ“šåº«é€£ç·š...');
          console.log('åŸ·è¡Œæ•¸æ“šåº«æŸ¥è©¢...');
          
          const startTime = Date.now();
          const { data, error } = await testClient
            .from('participants')
            .select('*')
            .limit(1)
            .timeout(5000); // 5ç§’è¶…æ™‚
          const endTime = Date.now();
          
          console.log('æŸ¥è©¢è€—æ™‚:', endTime - startTime, 'ms');
          console.log('æŸ¥è©¢çµæœ - data:', data);
          console.log('æŸ¥è©¢çµæœ - error:', error);
          
          if (error) {
            console.error('æ•¸æ“šåº«æŸ¥è©¢éŒ¯èª¤:', error);
            logMessage(`âŒ æ•¸æ“šåº«æŸ¥è©¢å¤±æ•—: ${error.message}`);
            logMessage(`éŒ¯èª¤ä»£ç¢¼: ${error.code || 'æœªçŸ¥'}`);
            
            if (error.code === '42P01') {
              logMessage('ğŸ’¡ æç¤º: å¯èƒ½æ˜¯è¡¨ä¸å­˜åœ¨ï¼Œè«‹ç¢ºèªæ•¸æ“šåº«çµæ§‹');
            } else if (error.code === '401') {
              logMessage('ğŸ’¡ æç¤º: å¯èƒ½æ˜¯API Keyç„¡æ•ˆæˆ–å·²éæœŸ');
            } else if (error.code === '403') {
              logMessage('ğŸ’¡ æç¤º: å¯èƒ½æ˜¯æ¬Šé™ä¸è¶³æˆ–IPè¢«é™åˆ¶');
            } else if (error.message.includes('network')) {
              logMessage('ğŸ’¡ æç¤º: å¯èƒ½æ˜¯ç¶²çµ¡å•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
            } else {
              logMessage('ğŸ’¡ æç¤º: è«‹æª¢æŸ¥Supabaseé …ç›®è¨­ç½®å’Œç¶²çµ¡é€£æ¥');
            }
            
            alert('æ¸¬è©¦å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒäº†è§£è©³æƒ…');
            return;
          }
          
          logMessage(`âœ… æ•¸æ“šåº«é€£ç·šæˆåŠŸï¼è¿”å›äº† ${data ? data.length : 0} æ¢æ•¸æ“š`);
          logMessage('ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼Œå¯ä»¥é€²è¡Œæ­£å¼é€£ç·š');
          alert('âœ… æ¸¬è©¦æˆåŠŸï¼é€£ç·šä¿¡æ¯æ­£ç¢º');
          
        } catch (dbError) {
          console.error('æ•¸æ“šåº«æ“ä½œç•°å¸¸:', dbError);
          throw dbError;
        }
        
      } catch (e) {
        console.error('æ¸¬è©¦éç¨‹ä¸­ç™¼ç”Ÿç•°å¸¸:', e);
        const errorMsg = e.message || e.toString();
        console.error('éŒ¯èª¤è©³æƒ…:', errorMsg);
        logMessage(`âŒ æ¸¬è©¦å¤±æ•—: ${errorMsg}`);
        logMessage('ğŸ’¡ å»ºè­°æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ç²å–æ›´å¤šè©³ç´°ä¿¡æ¯');
        alert('æ¸¬è©¦å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒå’Œç€è¦½å™¨æ§åˆ¶å°äº†è§£è©³æƒ…');
      }
    }
    
    async function connect() {
      const url = document.getElementById('url').value.trim();
      const key = document.getElementById('key').value.trim();
      const status = document.getElementById('status');
      
      try {
        if (!url || !key) {
          alert('âŒ URL æˆ– Key ç„¡å¡«');
          return;
        }

        // ä¿å­˜è¿æ¥ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('nfc_checkpoint_url', url);
        localStorage.setItem('nfc_checkpoint_key', key);

        // ç”± CDN å¼•å…¥ï¼Œå¿…é ˆç”¨ window.supabase.createClient
        client = window.supabase.createClient(url, key);

        status.textContent = 'é€£ç·šä¸­...';
        status.style.background = '#f59e0b';

        // åŠ è½½æ£€æŸ¥ç‚¹é…ç½®
        await loadCheckpoints();
        
        // æµ‹è¯•è¿æ¥ - å°è¯•è¯»å–participantsè¡¨
        const { data, error } = await client
          .from('participants')
          .select('*')
          .limit(1);

        if (error) throw error;

        status.textContent = 'âœ… å·²é€£ç·šï¼å¯é–‹å§‹æ‰“å¡';
        status.className = 'status connected';
        document.getElementById('punchBtn').disabled = false;

        logMessage('âœ… é€£ç·šæˆåŠŸï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨æ‰“å¡åŠŸèƒ½');
        
        // å¦‚æœæ˜¯NFCæ¨¡å¼ï¼Œåˆå§‹åŒ–NFCè¯»å–å™¨
        if (currentMode === 'nfc') {
          initNfcReader();
        }
        
      } catch (e) {
        console.error('è¿æ¥é”™è¯¯:', e);
        status.textContent = 'âŒ é€£ç·šå¤±æ•—';
        status.style.background = '#ef4444';
        alert('é€£ç·šå¤±æ•—ï¼š' + (e.message || e.toString()));
        logMessage('âŒ é€£ç·šå¤±æ•—ï¼š' + (e.message || e.toString()));
      }
    }
    
    // åŠ è½½æ£€æŸ¥ç‚¹é…ç½®
    async function loadCheckpoints() {
      if (!client) return;
      
      const { data, error } = await client
        .from('checkpoint_configs')
        .select('*')
        .eq('event_id', 'default')
        .order('order_index');
      
      if (error) {
        console.error('åŠ è½½æ£€æŸ¥ç‚¹é…ç½®å¤±è´¥:', error);
        logMessage('âš ï¸ æ— æ³•åŠ è½½æ£€æŸ¥ç‚¹é…ç½®ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
        // ä¿æŒé»˜è®¤é…ç½®
      } else if (data.length > 0) {
        checkpoints = data.map(cp => ({
          code: cp.code,
          name: cp.name,
          color: cp.code === 'START' ? '#10b981' : cp.code === 'FINISH' ? '#ef4444' : '#3b82f6'
        }));
        logMessage(`âœ… åŠ è½½äº† ${checkpoints.length} ä¸ªæ£€æŸ¥ç‚¹é…ç½®`);
      }
      
      // æ›´æ–°æ£€æŸ¥ç‚¹æŒ‰é’®
      updateCheckpointButtons();
      
      // å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©æ£€æŸ¥ç‚¹ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
      if (!currentCheckpoint && checkpoints.length > 0) {
        selectCheckpoint(checkpoints[0].code);
      }
    }
    
    // æ›´æ–°æ£€æŸ¥ç‚¹æŒ‰é’®
    function updateCheckpointButtons() {
      const grid = document.getElementById('checkpointGrid');
      grid.innerHTML = '';
      
      checkpoints.forEach(checkpoint => {
        const button = document.createElement('button');
        button.className = 'checkpoint-btn';
        button.style.background = checkpoint.color;
        button.innerHTML = checkpoint.name;
        button.onclick = () => selectCheckpoint(checkpoint.code);
        grid.appendChild(button);
      });
    }
    
    // é€‰æ‹©æ£€æŸ¥ç‚¹
    function selectCheckpoint(checkpointCode) {
      const checkpoint = checkpoints.find(cp => cp.code === checkpointCode);
      if (!checkpoint) return;
      
      currentCheckpoint = checkpointCode;
      document.getElementById('currentCheckpoint').textContent = checkpoint.name;
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('.checkpoint-btn').forEach(btn => {
        btn.style.opacity = '0.7';
        btn.style.transform = 'scale(1)';
      });
      
      const activeBtn = Array.from(document.querySelectorAll('.checkpoint-btn'))
        .find(btn => btn.onclick.toString().includes(checkpointCode));
      
      if (activeBtn) {
        activeBtn.style.opacity = '1';
        activeBtn.style.transform = 'scale(1.05)';
      }
      
      logMessage(`ğŸ”„ å·²é¸æ“‡æª¢æŸ¥é»: ${checkpoint.name}`);
    }
    
    // æ‰“å¡å½“å‰é€‰æ‹©çš„æ£€æŸ¥ç‚¹
    function punchCurrentCheckpoint() {
      if (!currentCheckpoint) {
        alert('è«‹å…ˆé¸æ“‡æª¢æŸ¥é»');
        return;
      }
      
      const bib = document.getElementById('bibInput').value.trim();
      if (!bib) {
        alert('è«‹è¼¸å…¥è™Ÿç¢¼å¸ƒç·¨è™Ÿ');
        return;
      }
      
      hitCheckpoint(currentCheckpoint, bib);
    }
    
    // æ ¸å¿ƒæ‰“å¡å‡½æ•° - ä¿®å¤æ•°æ®æ’å…¥é—®é¢˜
    async function hitCheckpoint(checkpointCode, bibNumber) {
      if (!client) {
        logMessage('âŒ æœªé€£ç·šåˆ°è³‡æ–™åº«ï¼Œç„¡æ³•æ‰“å¡');
        alert('æœªé€£ç·šåˆ°è³‡æ–™åº«ï¼Œç„¡æ³•æ‰“å¡');
        return;
      }
      
      if (!checkpointCode || !bibNumber) {
        logMessage('âŒ æª¢æŸ¥é»æˆ–è™Ÿç¢¼å¸ƒç·¨è™Ÿæœªå¡«å¯«å®Œæ•´');
        return;
      }
      
      try {
        // è·å–å½“å‰æ—¶é—´ï¼ˆUTC+8ï¼‰
        const now = new Date();
        // è½¬æ¢ä¸ºISOæ ¼å¼ï¼ŒåŒ…å«æ—¶åŒºä¿¡æ¯
        const timestamp = new Date(now.getTime() + 8 * 60 * 60 * 1000).toISOString();
        
        // æŸ¥æ‰¾æ£€æŸ¥ç‚¹åç§°
        const checkpoint = checkpoints.find(cp => cp.code === checkpointCode);
        const checkpointName = checkpoint ? checkpoint.name : checkpointCode;
        
        logMessage(`ğŸ“Œ æ­£åœ¨ç‚º ${bibNumber} åœ¨ ${checkpointName} æ‰“å¡...`);
        
        // å…ˆæ£€æŸ¥å‚èµ›è€…æ˜¯å¦å­˜åœ¨
        const { data: runnerData, error: runnerError } = await client
          .from('participants')
          .select('*')
          .eq('bib_number', bibNumber)
          .single();
          
        if (runnerError) {
          logMessage(`âš ï¸ æœªæ‰¾åˆ°è™Ÿç¢¼ ${bibNumber} çš„åƒè³½è€…ï¼Œä»æœƒè¨˜éŒ„æ‰“å¡`);
          console.warn('å‚èµ›è€…ä¸å­˜åœ¨:', runnerError);
        }
        
        // æ’å…¥æ‰“å¡è®°å½• - ä¿®å¤çš„æ ¸å¿ƒéƒ¨åˆ†
        const { data, error } = await client
          .from('checkins')
          .insert([{
            bib_number: bibNumber,
            checkpoint_code: checkpointCode,
            checkpoint_name: checkpointName,
            timestamp: timestamp,
            event_id: 'default'
          }])
          .select();
          
        if (error) {
          console.error('æ‰“å¡è®°å½•æ’å…¥å¤±è´¥:', error);
          logMessage(`âŒ æ‰“å¡å¤±æ•—: ${error.message}`);
          logMessage(`   éŒ¯èª¤ä»£ç¢¼: ${error.code || 'æœªçŸ¥'}`);
          
          // æä¾›æ›´å…·ä½“çš„é”™è¯¯æç¤º
          if (error.code === '23503') {
            logMessage('ğŸ’¡ å¯èƒ½æ˜¯æª¢æŸ¥é»ä»£ç¢¼ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥æª¢æŸ¥é»é…ç½®');
          } else if (error.message.includes('unique constraint')) {
            logMessage('ğŸ’¡ æ­¤åƒè³½è€…å·²åœ¨è©²æª¢æŸ¥é»æ‰“å¡é');
          }
          
          alert(`æ‰“å¡å¤±æ•—: ${error.message}`);
          return;
        }
        
        // æ‰“å¡æˆåŠŸå¤„ç†
        logMessage(`âœ… æ‰“å¡æˆåŠŸï¼è™Ÿç¢¼: ${bibNumber}ï¼Œæª¢æŸ¥é»: ${checkpointName}`);
        logMessage(`   æ™‚é–“: ${formatDateTime(timestamp)}`);
        
        // æ›´æ–°æœ€åæ‰“å¡å·ç 
        lastBibNumber = bibNumber;
        document.getElementById('lastBib').textContent = bibNumber;
        localStorage.setItem('nfc_last_bib', bibNumber);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('bibInput').value = '';
        
        // ç»™ç”¨æˆ·è§†è§‰åé¦ˆ
        const punchBtn = document.getElementById('punchBtn');
        punchBtn.style.background = '#10b981';
        setTimeout(() => {
          punchBtn.style.background = '';
        }, 500);
        
      } catch (e) {
        console.error('æ‰“å¡è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸:', e);
        logMessage(`âŒ æ‰“å¡éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${e.message || e.toString()}`);
        alert(`æ‰“å¡éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${e.message || e.toString()}`);
      }
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´æ˜¾ç¤º
    function formatDateTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('zh-HK', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    function setMode(mode, event) {
      currentMode = mode;
      localStorage.setItem('nfc_checkpoint_mode', mode);
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      if (event && event.target) {
        event.target.classList.add('active');
      } else {
        // å¦‚æœæ˜¯è‡ªåŠ¨è®¾ç½®æ¨¡å¼ï¼Œæ‰¾åˆ°å¯¹åº”æŒ‰é’®å¹¶æ¿€æ´»
        const btn = document.querySelector(`.mode-btn[onclick*="${mode}"]`);
        if (btn) btn.classList.add('active');
      }
      
      logMessage(`ğŸ”„ åˆ‡æ›åˆ°${mode === 'manual' ? 'æ‰‹å‹•è¼¸å…¥' : 'NFC'}æ¨¡å¼`);
      
      // å¦‚æœå·²è¿æ¥ä¸”åˆ‡æ¢åˆ°NFCæ¨¡å¼ï¼Œåˆå§‹åŒ–NFCè¯»å–å™¨
      if (client && mode === 'nfc') {
        initNfcReader();
      } else if (mode !== 'nfc' && typeof nfcReader === 'number') {
        // æ¸…é™¤æ¨¡æ‹Ÿå®šæ—¶å™¨
        clearInterval(nfcReader);
        nfcReader = null;
      }
    }
    
    // NFCæ¨¡å¼æƒé™è¯·æ±‚å‡½æ•°
    async function enableNfcMode(event) {
      logMessage('ğŸ”„ åˆ‡æ›åˆ°NFCæ¨¡å¼...');
      
      // ç›´æ¥åˆ‡æ¢åˆ°NFCæ¨¡å¼ï¼Œè®©initNfcReaderå¤„ç†å…·ä½“çš„åˆå§‹åŒ–é€»è¾‘
      setMode('nfc', event);
      
      // å¦‚æœå·²è¿æ¥ï¼Œç«‹å³åˆå§‹åŒ–NFCè¯»å–å™¨
      if (client) {
        initNfcReader();
      } else {
        logMessage('ğŸ’¡ æç¤º: è«‹å…ˆé€£ç·šè³‡æ–™åº«ï¼Œç„¶å¾Œæ‰‹å‹•é»æ“ŠNFCæ¨¡å¼æŒ‰éˆ•');
      }
    }
    
    function initNfcReader() {
      // æ¸…ç†ä¹‹å‰çš„æ¨¡æ‹Ÿå®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (typeof nfcReader === 'number') {
        clearInterval(nfcReader);
        nfcReader = null;
      }
      
      // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb NFC API
      if ('NDEFReader' in window) {
        logMessage('ğŸ“± Web NFC API æ”¯æŒï¼Œæ­£åœ¨å•Ÿç”¨çœŸå¯¦NFCæ¨¡å¼...');
        startWebNfcReader();
      } else {
        logMessage('âš ï¸  æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒWeb NFC APIï¼Œå°‡ä½¿ç”¨æ¨¡æ“¬æ¨¡å¼');
        logMessage('   è«‹ä½¿ç”¨Androidæ‰‹æ©Ÿä¸Šçš„Chromeç€è¦½å™¨ä»¥ç²å¾—çœŸå¯¦NFCæ”¯æŒ');
        startSimulatedNfcReader();
      }
    }
    
    async function startWebNfcReader() {
      try {
        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        if (!('NDEFReader' in window)) {
          logMessage('âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒWeb NFC API');
          logMessage('   è«‹ä½¿ç”¨Androidæ‰‹æ©Ÿä¸Šçš„Chromeç€è¦½å™¨ï¼ˆ89+ç‰ˆæœ¬ï¼‰');
          startSimulatedNfcReader();
          return;
        }
        
        // æ£€æŸ¥å®‰å…¨ä¸Šä¸‹æ–‡
        if (!window.isSecureContext) {
          logMessage('âš ï¸  éœ€è¦åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆHTTPSæˆ–localhostï¼‰ä¸­ä½¿ç”¨NFC');
          logMessage('   è«‹å°‡ç¶²ç«™éƒ¨ç½²åˆ°HTTPSæœå‹™å™¨æˆ–ä½¿ç”¨localhost');
          startSimulatedNfcReader();
          return;
        }
        
        const reader = new NDEFReader();
        
        // ç›‘å¬è¯»å–äº‹ä»¶
        reader.addEventListener('reading', (event) => {
          try {
            const message = event.message;
            for (const record of message.records) {
              // å°è¯•è§£ææ–‡æœ¬è®°å½•
              if (record.recordType === 'text') {
                const textDecoder = new TextDecoder(record.encoding || 'utf-8');
                const text = textDecoder.decode(record.data);
                logMessage(`ğŸ“± NFCæ¨™ç±¤å…§å®¹: ${text}`);
                
                // æå–è·‘æ‰‹è™Ÿç¢¼ï¼ˆå‡è¨­æ¨™ç±¤å…§å®¹å°±æ˜¯è™Ÿç¢¼ï¼‰
                const bib = extractBibNumber(text);
                if (bib) {
                  processNfcBibNumber(bib);
                } else {
                  logMessage(`âŒ ç„¡æ³•å¾NFCæ¨™ç±¤æå–æœ‰æ•ˆè™Ÿç¢¼: ${text}`);
                }
                return;
              }
              
              // å°è¯•è§£æURLè®°å½•
              if (record.recordType === 'url') {
                const textDecoder = new TextDecoder();
                const url = textDecoder.decode(record.data);
                logMessage(`ğŸŒ NFCæ¨™ç±¤URL: ${url}`);
                
                // ä»URLä¸­æå–å·ç 
                const bib = extractBibNumber(url);
                if (bib) {
                  processNfcBibNumber(bib);
                } else {
                  logMessage(`âŒ ç„¡æ³•å¾URLæå–æœ‰æ•ˆè™Ÿç¢¼: ${url}`);
                }
                return;
              }
            }
            logMessage(`âŒ ç„¡æ³•è§£æNFCæ¨™ç±¤å…§å®¹`);
          } catch (e) {
            logMessage(`âŒ NFCè®€å–éŒ¯èª¤: ${e.message}`);
          }
        });
        
        // ç›‘å¬é”™è¯¯äº‹ä»¶
        reader.addEventListener('error', (event) => {
          logMessage(`âŒ NFCè®€å–å™¨éŒ¯èª¤: ${event.error.message}`);
        });
        
        // è¯·æ±‚æ‰«æNFCæ ‡ç­¾
        await reader.scan();
        logMessage('ğŸ“± å·²æº–å‚™å°±ç·’ï¼Œè«‹å°‡NFCæ¨™ç±¤é è¿‘');
        
      } catch (e) {
        logMessage(`âŒ å•Ÿå‹•NFCè®€å–å™¨å¤±æ•—: ${e.message}`);
        console.error('NFCåˆå§‹åŒ–é”™è¯¯:', e);
        startSimulatedNfcReader(); // å¤±è´¥æ—¶åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
      }
    }
    
    // æ¨¡æ‹ŸNFCè¯»å–å™¨ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    function startSimulatedNfcReader() {
      logMessage('ğŸ“± æ¨¡æ“¬NFCæ¨¡å¼å·²å•Ÿç”¨ï¼Œæ¯5ç§’ç”¢ç”Ÿä¸€å€‹æ¨¡æ“¬è™Ÿç¢¼');
      
      // æ¨¡æ‹ŸNFCè¯»å–ï¼Œæ¯5ç§’ç”Ÿæˆä¸€ä¸ªéšæœºå·ç 
      nfcReader = setInterval(() => {
        const randomBib = Math.floor(100 + Math.random() * 900).toString(); // 100-999çš„éšæœºæ•°
        logMessage(`ğŸ“± æ¨¡æ“¬NFCè®€å–: è™Ÿç¢¼ ${randomBib}`);
        processNfcBibNumber(randomBib);
      }, 5000);
    }
    
    // å¤„ç†NFCè¯»å–åˆ°çš„å·ç 
    function processNfcBibNumber(bibNumber) {
      if (!currentCheckpoint) {
        logMessage('âŒ è«‹å…ˆé¸æ“‡æª¢æŸ¥é»å†é€²è¡ŒNFCæ‰“å¡');
        return;
      }
      
      // æ˜¾ç¤ºå·ç 
      document.getElementById('bibInput').value = bibNumber;
      
      // è‡ªåŠ¨æ‰“å¡
      hitCheckpoint(currentCheckpoint, bibNumber);
    }
    
    // ä»æ–‡æœ¬ä¸­æå–å·ç 
    function extractBibNumber(text) {
      // å°è¯•æå–æ•°å­—åºåˆ—
      const match = text.match(/\d+/);
      if (match) {
        return match[0];
      }
      return null;
    }
    
    // æ—¥å¿—è®°å½•å‡½æ•°
    function logMessage(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('zh-HK');
      const logEntry = document.createElement('div');
      logEntry.textContent = `[${timestamp}] ${message}`;
      logElement.appendChild(logEntry);
      logElement.scrollTop = logElement.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      console.log(`[LOG] ${message}`);
    }
  </script>
</body>
</html>
