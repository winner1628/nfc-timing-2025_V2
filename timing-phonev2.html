<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>ğŸ NFC è·‘æ‰‹æ‰“å¡æ©Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: white; /* æ›´æ”¹ç‚ºç™½è‰²èƒŒæ™¯ */
      color: #333; /* æ›´æ”¹ç‚ºé»‘è‰²æ–‡å­— */
      min-height: 100vh; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      padding: 20px; 
      text-align: center;
    }
    .card { 
      background: rgba(255,255,255,0.95); 
      border-radius: 24px; 
      padding: 40px; 
      max-width: 400px; 
      width: 100%; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
    }
    input { 
      width: 100%; 
      padding: 16px; 
      margin: 12px 0; 
      border: 1px solid #ddd; /* èª¿æ•´é‚Šæ¡†é¡è‰² */
      border-radius: 12px; 
      font-size: 16px; 
      box-sizing: border-box; 
    }
    button { 
      width: 100%; 
      padding: 20px; 
      margin: 12px 0; 
      border: none; 
      border-radius: 16px; 
      font-size: 18px; 
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.3s; 
    }
    .checkpoint-btn { 
      background: #3b82f6; 
      color: white; 
    }
    .start { background: #10b981; color: white; }
    .finish { background: #ef4444; color: white; }
    .start:active, .finish:active, .checkpoint-btn:active { transform: scale(0.98); }
    #log { 
      background: #f8fafc; 
      border-radius: 12px; 
      padding: 20px; 
      margin: 20px 0; 
      max-height: 300px; 
      overflow-y: auto; 
      font-family: monospace; 
      font-size: 14px; 
      color: #1e293b; 
    }
    .connected { background: #10b981 !important; }
    .status { 
      padding: 12px; 
      border-radius: 12px; 
      margin: 12px 0; 
      font-weight: bold; 
    }
    .mode-selector { margin: 20px 0; }
    .mode-btn { 
      padding: 8px 16px; 
      margin: 0 4px; 
      border: none; 
      border-radius: 20px; 
      cursor: pointer; 
      font-weight: bold; 
    }
    .mode-btn.active { background: #3b82f6; color: white; }
    .last-bib { 
      margin-top: 16px; 
      padding: 12px; 
      background: #f8fafc; 
      border-radius: 8px; 
      color: #1e293b; 
      font-weight: bold; 
    }
    .checkpoint-selector {
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸƒâ€â™‚ï¸ NFC è¨ˆæ™‚ç«™</h1>
    
    <div id="connectionSection" style="display: none;">
      <input id="url" placeholder="https://wceywyxwyygbwfodjdpp.supabase.co" value="YOUR_SUPABASE_URL">
      <input id="key" placeholder="sb_publishable_BWBxXzGk8bRGql3VbkCqbA_IZOfH5rc" type="password" value="YOUR_SUPABASE_KEY">
      <button onclick="connect()">ğŸ”— é€£ç·šè³‡æ–™åº«</button>
      <button onclick="testConnection()" style="background: #6366f1; margin-top: 8px;">ğŸ” æ¸¬è©¦é€£ç·š</button>
    </div>
    <button onclick="toggleConnectionSection()" style="background: #6b7280; margin-bottom: 12px;">âš™ï¸ è¨­ç½®</button>
    
    <div id="status" class="status" style="background: #f59e0b;">æœªé€£ç·š</div>
    
    <div class="mode-selector">
      <button class="mode-btn active" onclick="setMode('manual', event)">æ‰‹å‹•è¼¸å…¥</button>
      <button class="mode-btn" onclick="enableNfcMode(event)">NFCæ¨¡å¼</button>
    </div>
    
    <!-- æª¢æŸ¥é»é¸æ“‡å™¨ -->
    <div class="checkpoint-selector">
      <select id="checkpoint-select" style="width: 100%; padding: 12px; border-radius: 8px;">
        <!-- å°‡å¾å¾Œå°è¨­å®šå‹•æ…‹åŠ è¼‰ -->
        <option value="èµ·é»">èµ·é»</option>
        <option value="çµ‚é»">çµ‚é»</option>
      </select>
    </div>
    
    <button id="checkpointBtn" class="checkpoint-btn" onclick="hitCheckpoint()" disabled>ğŸ“Œ æ‰“å¡</button>
    
    <div class="last-bib">
      ä¸Šæ¬¡æ‰“å¡è™Ÿç¢¼: <span id="lastBib">-</span>
    </div>
    
    <div id="log">å³æ™‚è¨˜éŒ„æœƒé¡¯ç¤ºåœ¨æ­¤...</div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let client = null;
    let currentMode = 'manual';
    let lastBibNumber = '';
    let nfcReader = null;
    let currentRaceId = null;
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
    window.addEventListener('DOMContentLoaded', () => {
      // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–è¿æ¥ä¿¡æ¯
      const savedUrl = localStorage.getItem('nfc_checkpoint_url');
      const savedKey = localStorage.getItem('nfc_checkpoint_key');
      const savedMode = localStorage.getItem('nfc_checkpoint_mode');
      const savedLastBib = localStorage.getItem('nfc_last_bib');
      
      // è®¾ç½®é»˜è®¤è¿æ¥ä¿¡æ¯
      const defaultUrl = 'https://wceywyxwyygbwfodjdpp.supabase.co';
      const defaultKey = 'sb_publishable_BWBxXzGk8bRGql3VbkCqbA_IZOfH5rc';
      
      if (savedUrl && savedKey) {
        document.getElementById('url').value = savedUrl;
        document.getElementById('key').value = savedKey;
      } else {
        document.getElementById('url').value = defaultUrl;
        document.getElementById('key').value = defaultKey;
        localStorage.setItem('nfc_checkpoint_url', defaultUrl);
        localStorage.setItem('nfc_checkpoint_key', defaultKey);
      }
      
      // å»¶è¿Ÿ0.5ç§’è‡ªåŠ¨è¿æ¥
      setTimeout(() => connect(), 500);
      
      if (savedMode) {
        setMode(savedMode);
      }
      
      if (savedLastBib) {
        lastBibNumber = savedLastBib;
        document.getElementById('lastBib').textContent = savedLastBib;
      }
    });
    
    // åˆ‡æ¢è¿æ¥è®¾ç½®åŒºåŸŸçš„æ˜¾ç¤º/éšè—
    function toggleConnectionSection() {
      const section = document.getElementById('connectionSection');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        logMessage('âš™ï¸ é¡¯ç¤ºé€£ç·šè¨­ç½®');
      } else {
        section.style.display = 'none';
        logMessage('âš™ï¸ éš±è—é€£ç·šè¨­ç½®');
      }
    }
    
    // æµ‹è¯•è¿æ¥å‡½æ•°
    async function testConnection() {
      try {
        const url = document.getElementById('url').value.trim();
        const key = document.getElementById('key').value.trim();
        
        if (!url || !key) {
          const msg = 'âŒ è«‹å¡«å¯«URLå’ŒKey';
          alert(msg);
          return;
        }
        
        logMessage('ğŸ” é–‹å§‹æ¸¬è©¦é€£ç·š...');
        
        if (!window.supabase) {
          throw new Error('âŒ Supabase SDKæœªåŠ è¼‰');
        }
        
        logMessage('âœ… Supabase SDKå·²åŠ è¼‰');
        
        // åˆ›å»ºä¸´æ—¶å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥
        const testClient = window.supabase.createClient(url, key);
        logMessage('âœ… æˆåŠŸå‰µå»ºSupabaseå®¢æˆ¶ç«¯');
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        logMessage('ğŸ” æ¸¬è©¦æ•¸æ“šåº«é€£ç·š...');
        const { data, error } = await testClient
          .from('participants')
          .select('*')
          .limit(1)
          .timeout(5000);
        
        if (error) {
          console.error('æ•¸æ“šåº«æŸ¥è©¢éŒ¯èª¤:', error);
          logMessage(`âŒ æ•¸æ“šåº«æŸ¥è©¢å¤±æ•—: ${error.message}`);
          alert('æ¸¬è©¦å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒäº†è§£è©³æƒ…');
          return;
        }
        
        logMessage(`âœ… æ•¸æ“šåº«é€£ç·šæˆåŠŸï¼è¿”å›äº† ${data ? data.length : 0} æ¢æ•¸æ“š`);
        logMessage('ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼Œå¯ä»¥é€²è¡Œæ­£å¼é€£ç·š');
        alert('âœ… æ¸¬è©¦æˆåŠŸï¼é€£ç·šä¿¡æ¯æ­£ç¢º');
        
      } catch (e) {
        console.error('æ¸¬è©¦éç¨‹ä¸­ç™¼ç”Ÿç•°å¸¸:', e);
        logMessage(`âŒ æ¸¬è©¦å¤±æ•—: ${e.message}`);
        alert('æ¸¬è©¦å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒäº†è§£è©³æƒ…');
      }
    }
    
    async function connect() {
      const url = document.getElementById('url').value.trim();
      const key = document.getElementById('key').value.trim();
      const status = document.getElementById('status');
      
      try {
        if (!url || !key) {
          alert('âŒ URL æˆ– Key ç„¡å¡«');
          return;
        }

        // ä¿å­˜è¿æ¥ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('nfc_checkpoint_url', url);
        localStorage.setItem('nfc_checkpoint_key', key);

        // åˆ›å»ºSupabaseå®¢æˆ·ç«¯
        client = window.supabase.createClient(url, key);

        status.textContent = 'é€£ç·šä¸­...';
        status.style.background = '#f59e0b';

        // æµ‹è¯•è¿æ¥
        const { data, error } = await client
          .from('participants')
          .select('*')
          .limit(1);

        if (error) throw error;

        // åŠ è½½æ£€æŸ¥ç‚¹åˆ—è¡¨
        await loadCheckpoints();

        status.textContent = 'âœ… å·²é€£ç·šï¼å¯é–‹å§‹æ‰“å¡';
        status.className = 'status connected';
        document.getElementById('checkpointBtn').disabled = false;

        logMessage('âœ… é€£ç·šæˆåŠŸï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨æ‰“å¡åŠŸèƒ½');
        
        // å¦‚æœæ˜¯NFCæ¨¡å¼ï¼Œåˆå§‹åŒ–NFCè¯»å–å™¨
        if (currentMode === 'nfc') {
          initNfcReader();
        }
        
      } catch (e) {
        console.error('è¿æ¥é”™è¯¯:', e);
        status.textContent = 'âŒ é€£ç·šå¤±æ•—';
        status.style.background = '#ef4444';
        alert('é€£ç·šå¤±æ•—ï¼š' + (e.message || e.toString()));
        logMessage('âŒ é€£ç·šå¤±æ•—ï¼š' + (e.message || e.toString()));
      }
    }
    
    // åŠ è½½æ£€æŸ¥ç‚¹åˆ—è¡¨
    async function loadCheckpoints() {
      try {
        const { data } = await client
          .from('race_settings')
          .select('checkpoint_names, race_id')
          .eq('is_active', true)
          .order('created_at', { ascending: false })
          .limit(1);
        
        if (data && data[0]) {
          currentRaceId = data[0].race_id;
          const select = document.getElementById('checkpoint-select');
          select.innerHTML = '';
          
          data[0].checkpoint_names.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
          });
          
          logMessage(`âœ… åŠ è¼‰äº† ${data[0].checkpoint_names.length} å€‹æª¢æŸ¥é»`);
        }
        
      } catch (error) {
        console.error('åŠ è¼‰æª¢æŸ¥é»å¤±æ•—:', error);
        logMessage(`âš ï¸ åŠ è¼‰æª¢æŸ¥é»å¤±æ•—ï¼Œä½¿ç”¨é»˜èªå€¼: ${error.message}`);
      }
    }
    
    function setMode(mode, event) {
      currentMode = mode;
      localStorage.setItem('nfc_checkpoint_mode', mode);
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
      if (event && event.target) {
        event.target.classList.add('active');
      } else {
        const btn = document.querySelector(`.mode-btn[onclick*="${mode}"]`);
        if (btn) btn.classList.add('active');
      }
      
      logMessage(`ğŸ”„ åˆ‡æ›åˆ°${mode === 'manual' ? 'æ‰‹å‹•è¼¸å…¥' : 'NFC'}æ¨¡å¼`);
      
      // å¦‚æœå·²è¿æ¥ä¸”åˆ‡æ¢åˆ°NFCæ¨¡å¼ï¼Œåˆå§‹åŒ–NFCè¯»å–å™¨
      if (client && mode === 'nfc') {
        initNfcReader();
      }
    }
    
    // NFCæ¨¡å¼æƒé™è¯·æ±‚å‡½æ•°
    async function enableNfcMode(event) {
      logMessage('ğŸ”„ åˆ‡æ›åˆ°NFCæ¨¡å¼...');
      setMode('nfc', event);
      
      // å¦‚æœå·²è¿æ¥ï¼Œç«‹å³åˆå§‹åŒ–NFCè¯»å–å™¨
      if (client) {
        initNfcReader();
      } else {
        logMessage('ğŸ’¡ æç¤º: è«‹å…ˆé€£ç·šè³‡æ–™åº«');
      }
    }
    
    function initNfcReader() {
      // æ¸…ç†ä¹‹å‰çš„æ¨¡æ‹Ÿå®šæ—¶å™¨
      if (typeof nfcReader === 'number') {
        clearInterval(nfcReader);
        nfcReader = null;
      }
      
      // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb NFC API
      if ('NDEFReader' in window) {
        logMessage('ğŸ“± Web NFC API æ”¯æŒï¼Œæ­£åœ¨å•Ÿç”¨çœŸå¯¦NFCæ¨¡å¼...');
        startWebNfcReader();
      } else {
        logMessage('âš ï¸  æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒWeb NFC APIï¼Œå°‡ä½¿ç”¨æ¨¡æ“¬æ¨¡å¼');
        logMessage('   è«‹ä½¿ç”¨Androidæ‰‹æ©Ÿä¸Šçš„Chromeç€è¦½å™¨ä»¥ç²å¾—çœŸå¯¦NFCæ”¯æŒ');
        startSimulatedNfcReader();
      }
    }
    
    async function startWebNfcReader() {
      try {
        if (!('NDEFReader' in window)) {
          logMessage('âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒWeb NFC API');
          startSimulatedNfcReader();
          return;
        }
        
        if (!window.isSecureContext) {
          logMessage('âš ï¸  éœ€è¦åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆHTTPSæˆ–localhostï¼‰ä¸­ä½¿ç”¨NFC');
          startSimulatedNfcReader();
          return;
        }
        
        const reader = new NDEFReader();
        
        // ç›‘å¬è¯»å–äº‹ä»¶
        reader.addEventListener('reading', (event) => {
          try {
            const message = event.message;
            for (const record of message.records) {
              // å°è¯•è§£ææ–‡æœ¬è®°å½•
              if (record.recordType === 'text') {
                const textDecoder = new TextDecoder(record.encoding || 'utf-8');
                const text = textDecoder.decode(record.data);
                logMessage(`ğŸ“± NFCæ¨™ç±¤å…§å®¹: ${text}`);
                
                // æå–è·‘æ‰‹è™Ÿç¢¼
                const bib = extractBibNumber(text);
                if (bib) {
                  processNfcBibNumber(bib);
                } else {
                  logMessage(`âŒ ç„¡æ³•å¾NFCæ¨™ç±¤æå–æœ‰æ•ˆè™Ÿç¢¼: ${text}`);
                }
                return;
              }
              
              // å°è¯•è§£æURLè®°å½•
              if (record.recordType === 'url') {
                const urlDecoder = new TextDecoder();
                const url = urlDecoder.decode(record.data);
                logMessage(`ğŸ“± NFC URLæ¨™ç±¤: ${url}`);
                
                // å°è¯•ä»URLä¸­æå–å·ç 
                const bib = extractBibNumberFromUrl(url);
                if (bib) {
                  processNfcBibNumber(bib);
                } else {
                  logMessage(`âŒ ç„¡æ³•å¾URLæå–æœ‰æ•ˆè™Ÿç¢¼: ${url}`);
                }
                return;
              }
              
              logMessage(`ğŸ“± æœªçŸ¥NFCè¨˜éŒ„é¡å‹: ${record.recordType}`);
            }
          } catch (error) {
            logMessage(`âŒ NFCæ•¸æ“šè§£æéŒ¯èª¤: ${error.message}`);
          }
        });
        
        // ç›‘å¬é”™è¯¯äº‹ä»¶
        reader.addEventListener('readingerror', (error) => {
          logMessage(`âŒ NFCè®€å–éŒ¯èª¤: ${error.message}`);
        });
        
        // å¼€å§‹æ‰«æ
        logMessage('ğŸ” æ­£åœ¨å•Ÿå‹•NFCæƒæå™¨...');
        await reader.scan();
        logMessage('âœ… NFCæƒæå·²å•Ÿå‹•ï¼Œè«‹å°‡NFCæ¨™ç±¤é è¿‘æ‰‹æ©ŸèƒŒé¢');
        
      } catch (error) {
        logMessage(`âŒ NFCåˆå§‹åŒ–å¤±æ•—: ${error.message}`);
        
        if (error.name === 'NotAllowedError') {
          logMessage('ğŸ’¡ æç¤º: è«‹åœ¨ç€è¦½å™¨å½ˆå‡ºçš„æç¤ºä¸­å…è¨±ç¶²ç«™è¨ªå•NFCè¨­å‚™');
        } else if (error.name === 'SecurityError') {
          logMessage('ğŸ’¡ æç¤º: NFCåŠŸèƒ½éœ€è¦åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆHTTPSæˆ–localhostï¼‰ä¸­ä½¿ç”¨');
        }
        
        // åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ¨¡å¼
        startSimulatedNfcReader();
      }
    }
    
    function startSimulatedNfcReader() {
      logMessage('ğŸ® å•Ÿç”¨NFCæ¨¡æ“¬æ¨¡å¼ï¼Œæ¯5ç§’éš¨æ©Ÿç”Ÿæˆè™Ÿç¢¼');
      
      // æ¯5ç§’æ¨¡æ‹Ÿè¯»å–ä¸€æ¬¡NFCæ ‡ç­¾
      nfcReader = setInterval(() => {
        if (Math.random() > 0.6) { // 40%æ¦‚ç‡è¯»å–æˆåŠŸ
          const testBib = String(Math.floor(Math.random() * 999) + 1).padStart(3, '0');
          logMessage(`ğŸ® æ¨¡æ“¬NFCè®€å–: ${testBib}`);
          processNfcBibNumber(testBib);
        }
      }, 5000);
    }
    
    function extractBibNumber(text) {
      // å°è¯•ä»æ–‡æœ¬ä¸­æå–æ•°å­—å·ç 
      const match = text.match(/\d{1,3}/);
      if (match) {
        return String(parseInt(match[0])).padStart(3, '0');
      }
      return null;
    }
    
    function extractBibNumberFromUrl(url) {
      // å°è¯•ä»URLä¸­æå–å·ç 
      const pathMatch = url.match(/\/bib\/(\d{1,3})/);
      if (pathMatch) {
        return String(parseInt(pathMatch[1])).padStart(3, '0');
      }
      
      const queryMatch = url.match(/bib=(\d{1,3})/);
      if (queryMatch) {
        return String(parseInt(queryMatch[1])).padStart(3, '0');
      }
      
      return null;
    }
    
    function processNfcBibNumber(bib) {
      if (bib) {
        lastBibNumber = bib;
        document.getElementById('lastBib').textContent = bib;
        localStorage.setItem('nfc_last_bib', bib);
        
        // è‡ªåŠ¨æ‰“å¡
        hitCheckpoint();
      }
    }
    
    // æ‰“å¡å‡½æ•°
    async function hitCheckpoint() {
      if (!client) {
        alert('è«‹å…ˆé€£ç·šè³‡æ–™åº«');
        return;
      }
      
      if (!lastBibNumber && currentMode === 'nfc') {
        logMessage('âŒ æœªæª¢æ¸¬åˆ°è™Ÿç¢¼ï¼Œè«‹å†è©¦ä¸€æ¬¡');
        return;
      }
      
      // æ‰‹å‹•æ¨¡å¼ä¸‹è¦æ±‚è¼¸å…¥è™Ÿç¢¼
      let bibNumber = lastBibNumber;
      if (currentMode === 'manual') {
        const input = prompt('è«‹è¼¸å…¥è·‘æ‰‹è™Ÿç¢¼:');
        if (!input) return;
        
        // æ ¼å¼åŒ–ç‚º3ä½æ•¸å­—
        bibNumber = String(parseInt(input)).padStart(3, '0');
        if (isNaN(parseInt(bibNumber))) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—');
          return;
        }
        
        lastBibNumber = bibNumber;
        document.getElementById('lastBib').textContent = bibNumber;
        localStorage.setItem('nfc_last_bib', bibNumber);
      }
      
      // è·å–å½“å‰é€‰æ‹©çš„æ£€æŸ¥ç‚¹
      const checkpoint = document.getElementById('checkpoint-select').value;
      
      try {
        logMessage(`ğŸ“Œ æ­£åœ¨è¨˜éŒ„ ${bibNumber} åœ¨ ${checkpoint} çš„æ‰“å¡...`);
        
        // æ’å…¥æ‰“å¡è®°å½•
        const { data, error } = await client
          .from('events')
          .insert([{
            bib_number: bibNumber,
            checkpoint: checkpoint,
            race_id: currentRaceId
          }])
          .select();
        
        if (error) throw error;
        
        logMessage(`âœ… æˆåŠŸè¨˜éŒ„: ${bibNumber} åœ¨ ${checkpoint} æ‰“å¡`);
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥å‚èµ›è€…
        const { data: participants } = await client
          .from('participants')
          .select('name')
          .eq('bib_number', bibNumber)
          .single();
          
        if (participants) {
          logMessage(`ğŸ‘¤ è·‘æ‰‹: ${participants.name}`);
        } else {
          logMessage(`âš ï¸ æœªæ‰¾åˆ°è™Ÿç¢¼ ${bibNumber} çš„è·‘æ‰‹ä¿¡æ¯`);
        }
        
      } catch (e) {
        console.error('æ‰“å¡é”™è¯¯:', e);
        logMessage(`âŒ æ‰“å¡å¤±æ•—: ${e.message}`);
        alert('æ‰“å¡å¤±æ•—ï¼š' + e.message);
      }
    }
    
    // æ—¥å¿—å‡½æ•°
    function logMessage(message) {
      const log = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      log.innerHTML += `[${time}] ${message}<br>`;
      log.scrollTop = log.scrollHeight;
      console.log(`[${time}] ${message}`);
    }
  </script>
</body>
</html>
